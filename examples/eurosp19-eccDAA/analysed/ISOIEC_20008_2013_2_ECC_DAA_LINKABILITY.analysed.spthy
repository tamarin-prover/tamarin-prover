theory ISOIEC_20008_2013_2_ECC_DAA_LINKABILITY begin

// Function signature and definition of the equational theory E

functions: H1/1, H2/5, H3/5, H4/8, MAC/2, PRF/3, U/2, accept/0,
           adec/2, aenc/2, calcR1/1, calcR2/1, calcU/1, checkAnon/5, deanon/0,
           fst/1, minus/2, multp/2, pair/2, pk/1, plus/2, s/2, snd/1,
           verifyBlindCre/5, verifyCre/5, verifyMAC/3
equations:
    adec(aenc(x.1, pk(x.2)), x.2) = x.1,
    calcR1(minus(multp(s(randS1, PRF(DAASeed, Ki, cnt)), H1(bsn)),
                 multp(H4(H3(multp(l, multp(creRandom, P1)),
                             multp(l, multp(isk, multp(creRandom, P1))),
                             multp(l,
                                   plus(multp(isk, multp(creRandom, P1)),
                                        multp(multp(creRandom, isk),
                                              multp(P1, PRF(DAASeed, Ki, cnt))))),
                             multp(l,
                                   multp(PRF(DAASeed, Ki, cnt), multp(isk, multp(creRandom, P1)))),
                             nv),
                          m, H1(bsn), multp(PRF(DAASeed, Ki, cnt), H1(bsn)), bsn,
                          multp(randS1, H1(bsn)),
                          multp(randS1, multp(l, multp(isk, multp(creRandom, P1)))), nt),
                       multp(PRF(DAASeed, Ki, cnt), H1(bsn)))))
  = multp(randS1, H1(bsn)),
    calcR2(minus(multp(s(randS1, PRF(DAASeed, Ki, cnt)),
                       multp(l, multp(isk, multp(creRandom, P1)))),
                 multp(H4(H3(multp(l, multp(creRandom, P1)),
                             multp(l, multp(isk, multp(creRandom, P1))),
                             multp(l,
                                   plus(multp(isk, multp(creRandom, P1)),
                                        multp(multp(creRandom, isk),
                                              multp(P1, PRF(DAASeed, Ki, cnt))))),
                             multp(l,
                                   multp(PRF(DAASeed, Ki, cnt), multp(isk, multp(creRandom, P1)))),
                             nv),
                          m, H1(bsn), multp(PRF(DAASeed, Ki, cnt), H1(bsn)), bsn,
                          multp(randS1, H1(bsn)),
                          multp(randS1, multp(l, multp(isk, multp(creRandom, P1)))), nt),
                       multp(l,
                             multp(PRF(DAASeed, Ki, cnt), multp(isk, multp(creRandom, P1)))))))
  = multp(randS1, multp(l, multp(isk, multp(creRandom, P1)))),
    calcU(minus(multp(plus(u,
                           multp(H2(P1, multp(P1, PRF(DAASeed, Ki, cnt)), U(u, P1), pk(isk),
                                    ni),
                                 PRF(DAASeed, Ki, cnt))),
                      P1),
                multp(H2(P1, multp(P1, PRF(DAASeed, Ki, cnt)), U(u, P1), pk(isk),
                         ni),
                      multp(P1, PRF(DAASeed, Ki, cnt)))))
  = U(u, P1),
    checkAnon(multp(l, multp(isk, multp(creRandom, P1))),
              multp(l,
                    multp(PRF(DAASeed, Ki, cnt), multp(isk, multp(creRandom, P1)))),
              H1(bsn), multp(PRF(DAASeed, Ki, cnt), H1(bsn)),
              PRF(DAASeed, Ki, cnt))
  = deanon,
    fst(<x.1, x.2>) = x.1,
    snd(<x.1, x.2>) = x.2,
    verifyBlindCre(multp(l, multp(creRandom, P1)),
                   multp(l, multp(isk, multp(creRandom, P1))),
                   multp(l,
                         plus(multp(isk, multp(creRandom, P1)),
                              multp(multp(creRandom, isk), multp(P1, PRF(DAASeed, Ki, cnt))))),
                   multp(l,
                         multp(PRF(DAASeed, Ki, cnt), multp(isk, multp(creRandom, P1)))),
                   pk(isk))
  = accept,
    verifyCre(multp(creRandom, P1), multp(isk, multp(creRandom, P1)),
              plus(multp(isk, multp(creRandom, P1)),
                   multp(multp(creRandom, isk), multp(P1, PRF(DAASeed, Ki, cnt)))),
              multp(PRF(DAASeed, Ki, cnt), multp(isk, multp(creRandom, P1))),
              pk(isk))
  = accept,
    verifyMAC(m, MAC(m, k), k) = accept

restriction issuer_init:
  "∀ #i #j.
    ((IssuerInit( ) @ #i) ∧ (IssuerInit( ) @ #j)) ⇒ (#i = #j)"
  // safety formula

restriction unique_pairing:
  "∀ #i #j x.
    ((Unique_Pairing( x ) @ #i) ∧ (Unique_Pairing( x ) @ #j)) ⇒
    (#i = #j)"
  // safety formula

restriction platform_init:
  "∀ #i #j x y.
    ((PlatformStart( x, y ) @ #i) ∧ (PlatformStart( x, y ) @ #j)) ⇒
    (#i = #j)"
  // safety formula

restriction equality:
  "∀ #i x y. (Eq( x, y ) @ #i) ⇒ (x = y)"
  // safety formula

restriction inequality:
  "∀ #i x. (Neq( x, x ) @ #i) ⇒ (⊥)"
  // safety formula

rule (modulo E) ChanOut_S[color=#ffffff]:
   [ Out_S( $A, $B, x ), !F_Paired( $A, $B ) ]
  --[ ChanOut_S( $A, $B, x ) ]->
   [ Sec( $A, $B, x ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) ChanIn_S[color=#ffffff]:
   [ Sec( $A, $B, x ) ]
  --[ ChanIn_S( $A, $B, x ) ]->
   [ In_S( $A, $B, x ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) ISSUER_SETUP:
   [ Fr( ~Ki ), Fr( ~P1 ), Fr( ~isk ), Fr( ~bsn ) ]
  --[ IssuerInit( ), UniqueExecJoin( 'ISSUER_SETUP' ) ]->
   [
   !F_IssuerSK( $I, ~isk ), !F_IssuerPK( $I, pk(~isk) ),
   !F_IssuerKi( $I, ~Ki ), !F_IssuerGenerator( $I, ~P1 ),
   !F_BSN( $I, ~bsn ), Out( <pk(~isk), ~Ki, ~P1, ~bsn> )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) ISSUER_KEY_REVEAL:
   [ !F_IssuerSK( $I, isk ) ]
  --[ IssuerKeyReveal( $I ) ]->
   [ Out( isk ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) PLATFORM_CORRUPT:
   [ !F_PSEk( $PS, sk_ek ), !F_PSPkEk( $PS, pk_ek ) ]
  --[ RevealEK( $PS ) ]->
   [ Out( <sk_ek, pk_ek> ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) REVEAL_TSK:
   [ !F_PSTsk( $PS, tsk ) ]
  --[ RevealTsk( $PS ), RevealPSTsk( $PS, tsk ) ]->
   [ Out( <$PS, tsk> ), !RevealedPSTsk( $PS, tsk ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) PLATFORM_SETUP:
   [ Fr( ~sk_ek ) ]
  --[
  PlatformInit( ), PlatformStart( $AS, $PS ), Create( $PS ),
  Neq( $AS, $PS ), UniqueExecJoin( 'PLATFORM_SETUP' ),
  Unique_Pairing( $PS ), Unique_Pairing( $AS )
  ]->
   [
   !F_PSEk( $PS, ~sk_ek ), !F_PSPkEk( $PS, pk(~sk_ek) ),
   !F_Paired( $PS, $AS ), !F_Paired( $AS, $PS ),
   St_PlatformInit( $AS, $PS ), Out( pk(~sk_ek) )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) ISSUER_JOIN_ONE:
   [
   Fr( ~ni ), Fr( ~km ), !F_PSPkEk( $PS, pk_ek ),
   !F_IssuerPK( $I, ipk ), St_PlatformInit( $AS, $PS )
   ]
  --[
  UniqueExecJoin( 'ISSUER_JOIN_ONE' ), IssuerJoinOne( ), Create( $I )
  ]->
   [
   Out( aenc(<'ISSUER_REQ', ~km, ~ni>, pk_ek) ),
   St_ISSUER_JOIN_ONE( $I, $PS, ~km, ~ni )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) AS_JOIN_ONE:
   [ In( aenc(<'ISSUER_REQ', km, ni>, pk_ek) ) ]
  --[ UniqueExecJoin( 'AS_JOIN_ONE' ), ASJoinOne( ) ]->
   [ Out_S( $AS, $PS, aenc(<'ISSUER_REQ', km, ni>, pk_ek) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) PS_JOIN_ONE:
   [
   In_S( $AS, $PS, aenc(<'ISSUER_REQ', km, ni>, pk(sk_ek)) ),
   Fr( ~DAASeed ), Fr( ~cnt ), !F_IssuerKi( $I, Ki ),
   !F_PSEk( $PS, sk_ek ), !F_IssuerPK( $I, ipk ),
   !F_IssuerGenerator( $I, P1 ), Fr( ~u )
   ]
  --[
  UniqueExecJoin( 'PS_JOIN_ONE' ),
  DeriveTsk( PRF(~DAASeed, Ki, ~cnt) ), PSJoinOne( )
  ]->
   [
   Out_S( $PS, $AS,
          <'PS_RESP_OUT', multp(P1, PRF(~DAASeed, Ki, ~cnt)), 
           H2(P1, multp(P1, PRF(~DAASeed, Ki, ~cnt)), U(~u, P1), ipk, ni), 
           plus(~u,
                multp(H2(P1, multp(P1, PRF(~DAASeed, Ki, ~cnt)), U(~u, P1), ipk,
                         ni),
                      PRF(~DAASeed, Ki, ~cnt))), 
           MAC(<'gamma', P1, multp(P1, PRF(~DAASeed, Ki, ~cnt)), 
                H2(P1, multp(P1, PRF(~DAASeed, Ki, ~cnt)), U(~u, P1), ipk, ni), 
                plus(~u,
                     multp(H2(P1, multp(P1, PRF(~DAASeed, Ki, ~cnt)), U(~u, P1), ipk,
                              ni),
                           PRF(~DAASeed, Ki, ~cnt)))
               >,
               km)
          >
   ),
   !F_PSDaaSeed( $PS, ~DAASeed ), !F_PSCnt( $PS, ~cnt ),
   !F_PSTsk( $PS, PRF(~DAASeed, Ki, ~cnt) )
   ]

  // loop breaker: [0]
  /* has exactly the trivial AC variant */

rule (modulo E) AS_JOIN_TWO:
   [ In_S( $PS, $AS, <'PS_RESP_OUT', Q2, v, w, gamma> ) ]
  --[ UniqueExecJoin( 'AS_JOIN_TWO' ), ASJoinTwo( ) ]->
   [ Out( <'PS_RESP', Q2, v, w, gamma> ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) ISSUER_JOIN_TWO:
   [
   In( <'PS_RESP', Q2, v, w, MAC(<'gamma', P1, Q2, v, w>, km)> ),
   St_ISSUER_JOIN_ONE( $I, $PS, km, ni ), Fr( ~creRandom ),
   !F_IssuerSK( $I, isk ), !F_IssuerPK( $I, ipk ),
   !F_IssuerGenerator( $I, P1 ), !F_PSPkEk( $PS, pk_ek )
   ]
  --[
  Eq( verifyMAC(<'gamma', P1, Q2, v, w>,
                MAC(<'gamma', P1, Q2, v, w>, km), km),
      accept
  ),
  Eq( v,
      H2(P1, Q2, calcU(minus(multp(w, P1), multp(v, Q2))), ipk, ni)
  ),
  IssuerJoinTwo( ), UniqueExecJoin( 'ISSUER_JOIN_TWO' ),
  Running( $PS, $I,
           <'creI', multp(~creRandom, P1), multp(isk, multp(~creRandom, P1)), 
            plus(multp(isk, multp(~creRandom, P1)),
                 multp(multp(~creRandom, isk), Q2))
           >
  ),
  Honest( $I ), Honest( $PS )
  ]->
   [
   Out( aenc(<'creI', multp(~creRandom, P1), 
              multp(isk, multp(~creRandom, P1)), 
              plus(multp(isk, multp(~creRandom, P1)),
                   multp(multp(~creRandom, isk), Q2))
             >,
             pk_ek)
   )
   ]

  /*
  rule (modulo AC) ISSUER_JOIN_TWO:
     [
     In( <'PS_RESP', Q2, v, w, MAC(<'gamma', P1, Q2, v, w>, km)> ),
     St_ISSUER_JOIN_ONE( $I, $PS, km, ni ), Fr( ~creRandom ),
     !F_IssuerSK( $I, isk ), !F_IssuerPK( $I, ipk ),
     !F_IssuerGenerator( $I, P1 ), !F_PSPkEk( $PS, pk_ek )
     ]
    --[
    Eq( accept, accept ), Eq( v, H2(P1, Q2, z, ipk, ni) ),
    IssuerJoinTwo( ), UniqueExecJoin( 'ISSUER_JOIN_TWO' ),
    Running( $PS, $I,
             <'creI', multp(~creRandom, P1), multp(isk, multp(~creRandom, P1)), 
              plus(multp(isk, multp(~creRandom, P1)),
                   multp(multp(~creRandom, isk), Q2))
             >
    ),
    Honest( $I ), Honest( $PS )
    ]->
     [
     Out( aenc(<'creI', multp(~creRandom, P1), 
                multp(isk, multp(~creRandom, P1)), 
                plus(multp(isk, multp(~creRandom, P1)),
                     multp(multp(~creRandom, isk), Q2))
               >,
               pk_ek)
     )
     ]
    variants (modulo AC)
    1. P1    = P1.27
       Q2    = Q2.28
       v     = v.34
       w     = w.35
       z     = calcU(minus(multp(w.35, P1.27), multp(v.34, Q2.28)))
    
    2. P1    = P1.90
       Q2    = multp(P1.90, PRF(x.165, x.166, x.167))
       v     = H2(P1.90, multp(P1.90, PRF(x.165, x.166, x.167)),
                  U(x.173, P1.90), pk(x.174), x.175)
       w     = plus(x.173,
                    multp(H2(P1.90, multp(P1.90, PRF(x.165, x.166, x.167)),
                             U(x.173, P1.90), pk(x.174), x.175),
                          PRF(x.165, x.166, x.167)))
       z     = U(x.173, P1.90)
  */

rule (modulo E) AS_JOIN_THREE:
   [ In( aenc(<'creI', cre>, pk_ek) ) ]
  --[ ASJoinThree( ), UniqueExecJoin( 'AS_JOIN_THREE' ) ]->
   [ Out_S( $AS, $PS, aenc(<'creI', cre>, pk_ek) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) PS_JOIN_TWO:
   [
   In_S( $AS, $PS, aenc(<'creI', A, B, C>, pk(sk_ek)) ),
   !F_PSEk( $PS, sk_ek ), !F_PSTsk( $PS, PRF(DAASeed, Ki, cnt) )
   ]
  --[ PSJoinTwo( ), UniqueExecJoin( 'PS_JOIN_TWO' ) ]->
   [
   Out_S( $PS, $AS, <'cre', A, B, C, multp(PRF(DAASeed, Ki, cnt), B)>
   )
   ]

  // loop breaker: [0]
  /* has exactly the trivial AC variant */

rule (modulo E) AS_JOIN_FOUR:
   [ In_S( $PS, $AS, <'cre', A, B, C, D> ), !F_IssuerPK( $I, ipk ) ]
  --[
  ASJoinFour( ), UniqueExecJoin( 'AS_JOIN_FOUR' ), Honest( $PS ),
  Honest( $I ), Eq( verifyCre(A, B, C, D, ipk), accept ),
  Commit( $I, $PS, <'creI', A, B, C> ), Secret( $I, $PS, <A, B, C> )
  ]->
   [ !F_ASCre( $AS, $PS, <A, B, C, D> ) ]

  // loop breaker: [0]
  /*
  rule (modulo AC) AS_JOIN_FOUR:
     [ In_S( $PS, $AS, <'cre', A, B, C, D> ), !F_IssuerPK( $I, ipk ) ]
    --[
    ASJoinFour( ), UniqueExecJoin( 'AS_JOIN_FOUR' ), Honest( $PS ),
    Honest( $I ), Eq( z, accept ),
    Commit( $I, $PS, <'creI', A, B, C> ), Secret( $I, $PS, <A, B, C> )
    ]->
     [ !F_ASCre( $AS, $PS, <A, B, C, D> ) ]
    variants (modulo AC)
    1. A     = A.17
       B     = B.18
       C     = C.19
       D     = D.20
       ipk   = ipk.21
       z     = verifyCre(A.17, B.18, C.19, D.20, ipk.21)
    
    2. A     = multp(x.18, x.19)
       B     = multp(x.20, multp(x.18, x.19))
       C     = plus(multp(x.20, multp(x.18, x.19)),
                    multp(multp(x.18, x.20), multp(x.19, PRF(x.21, x.22, x.23))))
       D     = multp(PRF(x.21, x.22, x.23),
                     multp(x.20, multp(x.18, x.19)))
       ipk   = pk(x.20)
       z     = accept
    // loop breaker: [0]
  */

rule (modulo E) VERIFIER_SIGN_ONE:
   [ Fr( ~nv ), Fr( ~m ) ]
  --[
  VerifierSignOne( ), UniqueExecSign( 'VERIFIER_SIGN_ONE' ),
  Send( $V, ~nv )
  ]->
   [ Out( <'V1', ~nv, ~m> ), St_VERIFIER_SIGN_1( $V, ~nv, ~m ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) AS_SIGN_ONE:
   [
   In( <'V1', nv, m> ), !F_BSN( $I, bsn ), Fr( ~l ),
   !F_ASCre( $AS, $PS, <A, B, C, D> ), Fr( ~sid )
   ]
  --[ ASSignOne( ), UniqueExecSign( 'AS_SIGN_ONE' ) ]->
   [
   Out_S( $AS, $PS,
          <~sid, 'PSSign', 
           H3(multp(~l, A), multp(~l, B), multp(~l, C), multp(~l, D), nv), 
           H1(bsn), multp(~l, B), m, bsn>
   ),
   St_AS_SIGN_ONE( ~sid, $AS, multp(~l, A), multp(~l, B),
                   multp(~l, C), multp(~l, D), H1(bsn), nv, m
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) PS_SIGN_ONE:
   [
   In_S( $AS, $PS,
         <~sid, 'PSSign', H3(R, S, T, W, nv), H1(bsn), S, m, bsn>
   ),
   Fr( ~nt ), Fr( ~randS1 ), !F_PSTsk( $PS, PRF(DAASeed, Ki, cnt) )
   ]
  --[
  PSSignOne( ), DAASign( PRF(DAASeed, Ki, cnt), H1(bsn), nv ),
  UniqueExecSign( 'PS_SIGN_ONE' )
  ]->
   [
   Out_S( $PS, $AS,
          <~sid, 'PSSignResp', multp(PRF(DAASeed, Ki, cnt), H1(bsn)), 
           H4(H3(R, S, T, W, nv), m, H1(bsn),
              multp(PRF(DAASeed, Ki, cnt), H1(bsn)), bsn,
              multp(~randS1, H1(bsn)), multp(~randS1, S), ~nt), 
           s(~randS1, PRF(DAASeed, Ki, cnt)), ~nt>
   )
   ]

  // loop breaker: [0]
  /* has exactly the trivial AC variant */

rule (modulo E) AS_SIGN_TWO:
   [
   In_S( $PS, $AS, <~sid, 'PSSignResp', K, h, s(~randS1, tsk), ~nt> ),
   St_AS_SIGN_ONE( ~sid, $AS, R, S, T, W, H1(bsn), nv, m )
   ]
  --[
  ASSignTwo( ), UniqueExecSign( 'AS_SIGN_TWO' ),
  ASSendSignature( $AS, $PS, nv ),
  ASSendFullSignature( $AS, $PS,
                       <'sigma', R, S, T, W, H1(bsn), K, h, s(~randS1, tsk), nv, ~nt>
  )
  ]->
   [
   Sigma( <'sigma', R, S, T, W, H1(bsn), K, h, s(~randS1, tsk), nv, 
           ~nt>
   ),
   Out( <'sigma', m, 'sigma', R, S, T, W, H1(bsn), K, h, 
         s(~randS1, tsk), nv, ~nt>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) VERIFIER_VERIFY_ONE_WITH_STATE:
   [
   In( <'sigma', m, 'sigma', R, S, T, W, J, K, h, s(randS1, tsk), nv, 
        nt>
   ),
   St_VERIFIER_SIGN_1( $V, nv, m ), !F_BSN( $I, bsn ),
   !F_IssuerPK( $I, ipk )
   ]
  --[
  VerifierVerifyOneWS( ), UniqueExecSign( 'VERIFIER_VERIFY_ONE_WS' ),
  Eq( J, H1(bsn) ), Eq( verifyBlindCre(R, S, T, W, ipk), accept ),
  Eq( H4(H3(R, S, T, W, nv), m, J, K, bsn,
         calcR1(minus(multp(s(randS1, tsk), J), multp(h, K))),
         calcR2(minus(multp(s(randS1, tsk), S), multp(h, W))), nt),
      h
  ),
  Confirm( $V, nv )
  ]->
   [ ]

  /*
  rule (modulo AC) VERIFIER_VERIFY_ONE_WITH_STATE:
     [
     In( <'sigma', m, 'sigma', R, S, T, W, J, K, h, s(randS1, tsk), nv, 
          nt>
     ),
     St_VERIFIER_SIGN_1( $V, nv, m ), !F_BSN( $I, bsn ),
     !F_IssuerPK( $I, ipk )
     ]
    --[
    VerifierVerifyOneWS( ), UniqueExecSign( 'VERIFIER_VERIFY_ONE_WS' ),
    Eq( J, H1(bsn) ), Eq( z, accept ),
    Eq( H4(H3(R, S, T, W, nv), m, J, K, bsn, z.1, z.2, nt), h ),
    Confirm( $V, nv )
    ]->
     [ ]
    variants (modulo AC)
    1. J     = J.36
       K     = K.37
       R     = R.38
       S     = S.39
       T     = T.40
       W     = W.41
       h     = h.43
       ipk   = ipk.44
       randS1
             = randS1.48
       tsk   = tsk.49
       z     = verifyBlindCre(R.38, S.39, T.40, W.41, ipk.44)
       z.1   = calcR1(minus(multp(s(randS1.48, tsk.49), J.36),
                            multp(h.43, K.37)))
       z.2   = calcR2(minus(multp(s(randS1.48, tsk.49), S.39),
                            multp(h.43, W.41)))
    
    2. J     = J.48
       K     = K.49
       R     = multp(x.86, multp(x.87, x.88))
       S     = multp(x.86, multp(x.89, multp(x.87, x.88)))
       T     = multp(x.86,
                     plus(multp(x.89, multp(x.87, x.88)),
                          multp(multp(x.87, x.89), multp(x.88, PRF(x.90, x.91, x.92)))))
       W     = multp(x.86,
                     multp(PRF(x.90, x.91, x.92), multp(x.89, multp(x.87, x.88))))
       h     = h.55
       ipk   = pk(x.89)
       randS1
             = randS1.60
       tsk   = tsk.61
       z     = accept
       z.1   = calcR1(minus(multp(s(randS1.60, tsk.61), J.48),
                            multp(h.55, K.49)))
       z.2   = calcR2(minus(multp(s(randS1.60, tsk.61),
                                  multp(x.86, multp(x.89, multp(x.87, x.88)))),
                            multp(h.55,
                                  multp(x.86,
                                        multp(PRF(x.90, x.91, x.92),
                                              multp(x.89, multp(x.87, x.88)))))))
    
    3. J     = J.54
       K     = K.55
       R     = multp(x.92, multp(x.93, x.94))
       S     = multp(x.92, multp(x.95, multp(x.93, x.94)))
       T     = multp(x.92,
                     plus(multp(x.95, multp(x.93, x.94)),
                          multp(multp(x.93, x.95), multp(x.94, PRF(x.96, x.97, x.98)))))
       W     = multp(x.92,
                     multp(PRF(x.96, x.97, x.98), multp(x.95, multp(x.93, x.94))))
       h     = H4(H3(multp(x.92, multp(x.93, x.94)),
                     multp(x.92, multp(x.95, multp(x.93, x.94))),
                     multp(x.92,
                           plus(multp(x.95, multp(x.93, x.94)),
                                multp(multp(x.93, x.95), multp(x.94, PRF(x.96, x.97, x.98))))),
                     multp(x.92,
                           multp(PRF(x.96, x.97, x.98), multp(x.95, multp(x.93, x.94)))),
                     x.100),
                  x.101, H1(x.102), multp(PRF(x.96, x.97, x.98), H1(x.102)), x.102,
                  multp(randS1.66, H1(x.102)),
                  multp(randS1.66, multp(x.92, multp(x.95, multp(x.93, x.94)))),
                  x.104)
       ipk   = pk(x.95)
       randS1
             = randS1.66
       tsk   = PRF(x.96, x.97, x.98)
       z     = accept
       z.1   = calcR1(minus(multp(s(randS1.66, PRF(x.96, x.97, x.98)),
                                  J.54),
                            multp(H4(H3(multp(x.92, multp(x.93, x.94)),
                                        multp(x.92, multp(x.95, multp(x.93, x.94))),
                                        multp(x.92,
                                              plus(multp(x.95, multp(x.93, x.94)),
                                                   multp(multp(x.93, x.95),
                                                         multp(x.94, PRF(x.96, x.97, x.98))))),
                                        multp(x.92,
                                              multp(PRF(x.96, x.97, x.98),
                                                    multp(x.95, multp(x.93, x.94)))),
                                        x.100),
                                     x.101, H1(x.102), multp(PRF(x.96, x.97, x.98), H1(x.102)),
                                     x.102, multp(randS1.66, H1(x.102)),
                                     multp(randS1.66, multp(x.92, multp(x.95, multp(x.93, x.94)))),
                                     x.104),
                                  K.55)))
       z.2   = multp(randS1.66,
                     multp(x.92, multp(x.95, multp(x.93, x.94))))
    
    4. J     = J.55
       K     = K.56
       R     = R.57
       S     = multp(x.93, multp(x.94, multp(x.95, x.96)))
       T     = T.59
       W     = multp(x.93,
                     multp(PRF(x.98, x.99, x.100), multp(x.94, multp(x.95, x.96))))
       h     = H4(H3(multp(x.93, multp(x.95, x.96)),
                     multp(x.93, multp(x.94, multp(x.95, x.96))),
                     multp(x.93,
                           plus(multp(x.94, multp(x.95, x.96)),
                                multp(multp(x.95, x.94), multp(x.96, PRF(x.98, x.99, x.100))))),
                     multp(x.93,
                           multp(PRF(x.98, x.99, x.100), multp(x.94, multp(x.95, x.96)))),
                     x.102),
                  x.103, H1(x.104), multp(PRF(x.98, x.99, x.100), H1(x.104)), x.104,
                  multp(randS1.67, H1(x.104)),
                  multp(randS1.67, multp(x.93, multp(x.94, multp(x.95, x.96)))),
                  x.106)
       ipk   = ipk.63
       randS1
             = randS1.67
       tsk   = PRF(x.98, x.99, x.100)
       z     = verifyBlindCre(R.57,
                              multp(x.93, multp(x.94, multp(x.95, x.96))), T.59,
                              multp(x.93,
                                    multp(PRF(x.98, x.99, x.100), multp(x.94, multp(x.95, x.96)))),
                              ipk.63)
       z.1   = calcR1(minus(multp(s(randS1.67, PRF(x.98, x.99, x.100)),
                                  J.55),
                            multp(H4(H3(multp(x.93, multp(x.95, x.96)),
                                        multp(x.93, multp(x.94, multp(x.95, x.96))),
                                        multp(x.93,
                                              plus(multp(x.94, multp(x.95, x.96)),
                                                   multp(multp(x.95, x.94),
                                                         multp(x.96, PRF(x.98, x.99, x.100))))),
                                        multp(x.93,
                                              multp(PRF(x.98, x.99, x.100),
                                                    multp(x.94, multp(x.95, x.96)))),
                                        x.102),
                                     x.103, H1(x.104), multp(PRF(x.98, x.99, x.100), H1(x.104)),
                                     x.104, multp(randS1.67, H1(x.104)),
                                     multp(randS1.67, multp(x.93, multp(x.94, multp(x.95, x.96)))),
                                     x.106),
                                  K.56)))
       z.2   = multp(randS1.67,
                     multp(x.93, multp(x.94, multp(x.95, x.96))))
    
    5. J     = H1(x.56)
       K     = multp(PRF(x.57, x.58, x.59), H1(x.56))
       R     = multp(x.60, multp(x.61, x.62))
       S     = multp(x.60, multp(x.63, multp(x.61, x.62)))
       T     = multp(x.60,
                     plus(multp(x.63, multp(x.61, x.62)),
                          multp(multp(x.61, x.63), multp(x.62, PRF(x.57, x.58, x.59)))))
       W     = multp(x.60,
                     multp(PRF(x.57, x.58, x.59), multp(x.63, multp(x.61, x.62))))
       h     = H4(H3(multp(x.60, multp(x.61, x.62)),
                     multp(x.60, multp(x.63, multp(x.61, x.62))),
                     multp(x.60,
                           plus(multp(x.63, multp(x.61, x.62)),
                                multp(multp(x.61, x.63), multp(x.62, PRF(x.57, x.58, x.59))))),
                     multp(x.60,
                           multp(PRF(x.57, x.58, x.59), multp(x.63, multp(x.61, x.62)))),
                     x.65),
                  x.66, H1(x.56), multp(PRF(x.57, x.58, x.59), H1(x.56)), x.56,
                  multp(randS1.42, H1(x.56)),
                  multp(randS1.42, multp(x.60, multp(x.63, multp(x.61, x.62)))),
                  x.68)
       ipk   = pk(x.63)
       randS1
             = randS1.42
       tsk   = PRF(x.57, x.58, x.59)
       z     = accept
       z.1   = multp(randS1.42, H1(x.56))
       z.2   = multp(randS1.42,
                     multp(x.60, multp(x.63, multp(x.61, x.62))))
    
    6. J     = H1(x.63)
       K     = multp(PRF(x.64, x.65, x.66), H1(x.63))
       R     = multp(x.67, multp(x.68, x.69))
       S     = multp(x.67, multp(x.70, multp(x.68, x.69)))
       T     = multp(x.67,
                     plus(multp(x.70, multp(x.68, x.69)),
                          multp(multp(x.68, x.70), multp(x.69, PRF(x.71, x.72, x.73)))))
       W     = multp(x.67,
                     multp(PRF(x.71, x.72, x.73), multp(x.70, multp(x.68, x.69))))
       h     = H4(H3(multp(x.75, multp(x.76, x.77)),
                     multp(x.75, multp(x.78, multp(x.76, x.77))),
                     multp(x.75,
                           plus(multp(x.78, multp(x.76, x.77)),
                                multp(multp(x.76, x.78), multp(x.77, PRF(x.64, x.65, x.66))))),
                     multp(x.75,
                           multp(PRF(x.64, x.65, x.66), multp(x.78, multp(x.76, x.77)))),
                     x.79),
                  x.80, H1(x.63), multp(PRF(x.64, x.65, x.66), H1(x.63)), x.63,
                  multp(randS1.49, H1(x.63)),
                  multp(randS1.49, multp(x.75, multp(x.78, multp(x.76, x.77)))),
                  x.82)
       ipk   = pk(x.70)
       randS1
             = randS1.49
       tsk   = PRF(x.64, x.65, x.66)
       z     = accept
       z.1   = multp(randS1.49, H1(x.63))
       z.2   = calcR2(minus(multp(s(randS1.49, PRF(x.64, x.65, x.66)),
                                  multp(x.67, multp(x.70, multp(x.68, x.69)))),
                            multp(H4(H3(multp(x.75, multp(x.76, x.77)),
                                        multp(x.75, multp(x.78, multp(x.76, x.77))),
                                        multp(x.75,
                                              plus(multp(x.78, multp(x.76, x.77)),
                                                   multp(multp(x.76, x.78),
                                                         multp(x.77, PRF(x.64, x.65, x.66))))),
                                        multp(x.75,
                                              multp(PRF(x.64, x.65, x.66),
                                                    multp(x.78, multp(x.76, x.77)))),
                                        x.79),
                                     x.80, H1(x.63), multp(PRF(x.64, x.65, x.66), H1(x.63)), x.63,
                                     multp(randS1.49, H1(x.63)),
                                     multp(randS1.49, multp(x.75, multp(x.78, multp(x.76, x.77)))),
                                     x.82),
                                  multp(x.67,
                                        multp(PRF(x.71, x.72, x.73),
                                              multp(x.70, multp(x.68, x.69)))))))
    
    7. J     = H1(x.88)
       K     = multp(PRF(x.89, x.90, x.91), H1(x.88))
       R     = R.54
       S     = multp(x.93, multp(x.94, multp(x.95, x.96)))
       T     = T.56
       W     = multp(x.93,
                     multp(PRF(x.89, x.90, x.91), multp(x.94, multp(x.95, x.96))))
       h     = H4(H3(multp(x.93, multp(x.95, x.96)),
                     multp(x.93, multp(x.94, multp(x.95, x.96))),
                     multp(x.93,
                           plus(multp(x.94, multp(x.95, x.96)),
                                multp(multp(x.95, x.94), multp(x.96, PRF(x.89, x.90, x.91))))),
                     multp(x.93,
                           multp(PRF(x.89, x.90, x.91), multp(x.94, multp(x.95, x.96)))),
                     x.99),
                  x.100, H1(x.88), multp(PRF(x.89, x.90, x.91), H1(x.88)), x.88,
                  multp(randS1.64, H1(x.88)),
                  multp(randS1.64, multp(x.93, multp(x.94, multp(x.95, x.96)))),
                  x.102)
       ipk   = ipk.60
       randS1
             = randS1.64
       tsk   = PRF(x.89, x.90, x.91)
       z     = verifyBlindCre(R.54,
                              multp(x.93, multp(x.94, multp(x.95, x.96))), T.56,
                              multp(x.93,
                                    multp(PRF(x.89, x.90, x.91), multp(x.94, multp(x.95, x.96)))),
                              ipk.60)
       z.1   = multp(randS1.64, H1(x.88))
       z.2   = multp(randS1.64,
                     multp(x.93, multp(x.94, multp(x.95, x.96))))
    
    8. J     = H1(x.90)
       K     = multp(PRF(x.91, x.92, x.93), H1(x.90))
       R     = R.56
       S     = S.57
       T     = T.58
       W     = W.59
       h     = H4(H3(multp(x.99, multp(x.100, x.101)),
                     multp(x.99, multp(x.102, multp(x.100, x.101))),
                     multp(x.99,
                           plus(multp(x.102, multp(x.100, x.101)),
                                multp(multp(x.100, x.102), multp(x.101, PRF(x.91, x.92, x.93))))),
                     multp(x.99,
                           multp(PRF(x.91, x.92, x.93), multp(x.102, multp(x.100, x.101)))),
                     x.103),
                  x.104, H1(x.90), multp(PRF(x.91, x.92, x.93), H1(x.90)), x.90,
                  multp(randS1.66, H1(x.90)),
                  multp(randS1.66, multp(x.99, multp(x.102, multp(x.100, x.101)))),
                  x.106)
       ipk   = ipk.62
       randS1
             = randS1.66
       tsk   = PRF(x.91, x.92, x.93)
       z     = verifyBlindCre(R.56, S.57, T.58, W.59, ipk.62)
       z.1   = multp(randS1.66, H1(x.90))
       z.2   = calcR2(minus(multp(s(randS1.66, PRF(x.91, x.92, x.93)),
                                  S.57),
                            multp(H4(H3(multp(x.99, multp(x.100, x.101)),
                                        multp(x.99, multp(x.102, multp(x.100, x.101))),
                                        multp(x.99,
                                              plus(multp(x.102, multp(x.100, x.101)),
                                                   multp(multp(x.100, x.102),
                                                         multp(x.101, PRF(x.91, x.92, x.93))))),
                                        multp(x.99,
                                              multp(PRF(x.91, x.92, x.93),
                                                    multp(x.102, multp(x.100, x.101)))),
                                        x.103),
                                     x.104, H1(x.90), multp(PRF(x.91, x.92, x.93), H1(x.90)), x.90,
                                     multp(randS1.66, H1(x.90)),
                                     multp(randS1.66,
                                           multp(x.99, multp(x.102, multp(x.100, x.101)))),
                                     x.106),
                                  W.59)))
  */

rule (modulo E) VERIFIER_VERIFY_ONE_NO_STATE:
   [
   In( <'sigma', m, 'sigma', R, S, T, W, J, K, h, s(randS1, tsk), nv, 
        nt>
   ),
   !F_BSN( $I, bsn ), !F_IssuerPK( $I, ipk )
   ]
  --[
  VerifierVerifyOneNS( ), UniqueExecSign( 'VERIFIER_VERIFY_ONE_NS' ),
  Eq( J, H1(bsn) ), Eq( verifyBlindCre(R, S, T, W, ipk), accept ),
  Eq( H4(H3(R, S, T, W, nv), m, J, K, bsn,
         calcR1(minus(multp(s(randS1, tsk), J), multp(h, K))),
         calcR2(minus(multp(s(randS1, tsk), S), multp(h, W))), nt),
      h
  ),
  Confirm( $V, nv )
  ]->
   [ ]

  /*
  rule (modulo AC) VERIFIER_VERIFY_ONE_NO_STATE:
     [
     In( <'sigma', m, 'sigma', R, S, T, W, J, K, h, s(randS1, tsk), nv, 
          nt>
     ),
     !F_BSN( $I, bsn ), !F_IssuerPK( $I, ipk )
     ]
    --[
    VerifierVerifyOneNS( ), UniqueExecSign( 'VERIFIER_VERIFY_ONE_NS' ),
    Eq( J, H1(bsn) ), Eq( z, accept ),
    Eq( H4(H3(R, S, T, W, nv), m, J, K, bsn, z.1, z.2, nt), h ),
    Confirm( $V, nv )
    ]->
     [ ]
    variants (modulo AC)
    1. J     = J.36
       K     = K.37
       R     = R.38
       S     = S.39
       T     = T.40
       W     = W.41
       h     = h.43
       ipk   = ipk.44
       randS1
             = randS1.48
       tsk   = tsk.49
       z     = verifyBlindCre(R.38, S.39, T.40, W.41, ipk.44)
       z.1   = calcR1(minus(multp(s(randS1.48, tsk.49), J.36),
                            multp(h.43, K.37)))
       z.2   = calcR2(minus(multp(s(randS1.48, tsk.49), S.39),
                            multp(h.43, W.41)))
    
    2. J     = J.48
       K     = K.49
       R     = multp(x.86, multp(x.87, x.88))
       S     = multp(x.86, multp(x.89, multp(x.87, x.88)))
       T     = multp(x.86,
                     plus(multp(x.89, multp(x.87, x.88)),
                          multp(multp(x.87, x.89), multp(x.88, PRF(x.90, x.91, x.92)))))
       W     = multp(x.86,
                     multp(PRF(x.90, x.91, x.92), multp(x.89, multp(x.87, x.88))))
       h     = h.55
       ipk   = pk(x.89)
       randS1
             = randS1.60
       tsk   = tsk.61
       z     = accept
       z.1   = calcR1(minus(multp(s(randS1.60, tsk.61), J.48),
                            multp(h.55, K.49)))
       z.2   = calcR2(minus(multp(s(randS1.60, tsk.61),
                                  multp(x.86, multp(x.89, multp(x.87, x.88)))),
                            multp(h.55,
                                  multp(x.86,
                                        multp(PRF(x.90, x.91, x.92),
                                              multp(x.89, multp(x.87, x.88)))))))
    
    3. J     = J.54
       K     = K.55
       R     = multp(x.92, multp(x.93, x.94))
       S     = multp(x.92, multp(x.95, multp(x.93, x.94)))
       T     = multp(x.92,
                     plus(multp(x.95, multp(x.93, x.94)),
                          multp(multp(x.93, x.95), multp(x.94, PRF(x.96, x.97, x.98)))))
       W     = multp(x.92,
                     multp(PRF(x.96, x.97, x.98), multp(x.95, multp(x.93, x.94))))
       h     = H4(H3(multp(x.92, multp(x.93, x.94)),
                     multp(x.92, multp(x.95, multp(x.93, x.94))),
                     multp(x.92,
                           plus(multp(x.95, multp(x.93, x.94)),
                                multp(multp(x.93, x.95), multp(x.94, PRF(x.96, x.97, x.98))))),
                     multp(x.92,
                           multp(PRF(x.96, x.97, x.98), multp(x.95, multp(x.93, x.94)))),
                     x.100),
                  x.101, H1(x.102), multp(PRF(x.96, x.97, x.98), H1(x.102)), x.102,
                  multp(randS1.66, H1(x.102)),
                  multp(randS1.66, multp(x.92, multp(x.95, multp(x.93, x.94)))),
                  x.104)
       ipk   = pk(x.95)
       randS1
             = randS1.66
       tsk   = PRF(x.96, x.97, x.98)
       z     = accept
       z.1   = calcR1(minus(multp(s(randS1.66, PRF(x.96, x.97, x.98)),
                                  J.54),
                            multp(H4(H3(multp(x.92, multp(x.93, x.94)),
                                        multp(x.92, multp(x.95, multp(x.93, x.94))),
                                        multp(x.92,
                                              plus(multp(x.95, multp(x.93, x.94)),
                                                   multp(multp(x.93, x.95),
                                                         multp(x.94, PRF(x.96, x.97, x.98))))),
                                        multp(x.92,
                                              multp(PRF(x.96, x.97, x.98),
                                                    multp(x.95, multp(x.93, x.94)))),
                                        x.100),
                                     x.101, H1(x.102), multp(PRF(x.96, x.97, x.98), H1(x.102)),
                                     x.102, multp(randS1.66, H1(x.102)),
                                     multp(randS1.66, multp(x.92, multp(x.95, multp(x.93, x.94)))),
                                     x.104),
                                  K.55)))
       z.2   = multp(randS1.66,
                     multp(x.92, multp(x.95, multp(x.93, x.94))))
    
    4. J     = J.55
       K     = K.56
       R     = R.57
       S     = multp(x.93, multp(x.94, multp(x.95, x.96)))
       T     = T.59
       W     = multp(x.93,
                     multp(PRF(x.98, x.99, x.100), multp(x.94, multp(x.95, x.96))))
       h     = H4(H3(multp(x.93, multp(x.95, x.96)),
                     multp(x.93, multp(x.94, multp(x.95, x.96))),
                     multp(x.93,
                           plus(multp(x.94, multp(x.95, x.96)),
                                multp(multp(x.95, x.94), multp(x.96, PRF(x.98, x.99, x.100))))),
                     multp(x.93,
                           multp(PRF(x.98, x.99, x.100), multp(x.94, multp(x.95, x.96)))),
                     x.102),
                  x.103, H1(x.104), multp(PRF(x.98, x.99, x.100), H1(x.104)), x.104,
                  multp(randS1.67, H1(x.104)),
                  multp(randS1.67, multp(x.93, multp(x.94, multp(x.95, x.96)))),
                  x.106)
       ipk   = ipk.63
       randS1
             = randS1.67
       tsk   = PRF(x.98, x.99, x.100)
       z     = verifyBlindCre(R.57,
                              multp(x.93, multp(x.94, multp(x.95, x.96))), T.59,
                              multp(x.93,
                                    multp(PRF(x.98, x.99, x.100), multp(x.94, multp(x.95, x.96)))),
                              ipk.63)
       z.1   = calcR1(minus(multp(s(randS1.67, PRF(x.98, x.99, x.100)),
                                  J.55),
                            multp(H4(H3(multp(x.93, multp(x.95, x.96)),
                                        multp(x.93, multp(x.94, multp(x.95, x.96))),
                                        multp(x.93,
                                              plus(multp(x.94, multp(x.95, x.96)),
                                                   multp(multp(x.95, x.94),
                                                         multp(x.96, PRF(x.98, x.99, x.100))))),
                                        multp(x.93,
                                              multp(PRF(x.98, x.99, x.100),
                                                    multp(x.94, multp(x.95, x.96)))),
                                        x.102),
                                     x.103, H1(x.104), multp(PRF(x.98, x.99, x.100), H1(x.104)),
                                     x.104, multp(randS1.67, H1(x.104)),
                                     multp(randS1.67, multp(x.93, multp(x.94, multp(x.95, x.96)))),
                                     x.106),
                                  K.56)))
       z.2   = multp(randS1.67,
                     multp(x.93, multp(x.94, multp(x.95, x.96))))
    
    5. J     = H1(x.56)
       K     = multp(PRF(x.57, x.58, x.59), H1(x.56))
       R     = multp(x.60, multp(x.61, x.62))
       S     = multp(x.60, multp(x.63, multp(x.61, x.62)))
       T     = multp(x.60,
                     plus(multp(x.63, multp(x.61, x.62)),
                          multp(multp(x.61, x.63), multp(x.62, PRF(x.57, x.58, x.59)))))
       W     = multp(x.60,
                     multp(PRF(x.57, x.58, x.59), multp(x.63, multp(x.61, x.62))))
       h     = H4(H3(multp(x.60, multp(x.61, x.62)),
                     multp(x.60, multp(x.63, multp(x.61, x.62))),
                     multp(x.60,
                           plus(multp(x.63, multp(x.61, x.62)),
                                multp(multp(x.61, x.63), multp(x.62, PRF(x.57, x.58, x.59))))),
                     multp(x.60,
                           multp(PRF(x.57, x.58, x.59), multp(x.63, multp(x.61, x.62)))),
                     x.65),
                  x.66, H1(x.56), multp(PRF(x.57, x.58, x.59), H1(x.56)), x.56,
                  multp(randS1.42, H1(x.56)),
                  multp(randS1.42, multp(x.60, multp(x.63, multp(x.61, x.62)))),
                  x.68)
       ipk   = pk(x.63)
       randS1
             = randS1.42
       tsk   = PRF(x.57, x.58, x.59)
       z     = accept
       z.1   = multp(randS1.42, H1(x.56))
       z.2   = multp(randS1.42,
                     multp(x.60, multp(x.63, multp(x.61, x.62))))
    
    6. J     = H1(x.63)
       K     = multp(PRF(x.64, x.65, x.66), H1(x.63))
       R     = multp(x.67, multp(x.68, x.69))
       S     = multp(x.67, multp(x.70, multp(x.68, x.69)))
       T     = multp(x.67,
                     plus(multp(x.70, multp(x.68, x.69)),
                          multp(multp(x.68, x.70), multp(x.69, PRF(x.71, x.72, x.73)))))
       W     = multp(x.67,
                     multp(PRF(x.71, x.72, x.73), multp(x.70, multp(x.68, x.69))))
       h     = H4(H3(multp(x.75, multp(x.76, x.77)),
                     multp(x.75, multp(x.78, multp(x.76, x.77))),
                     multp(x.75,
                           plus(multp(x.78, multp(x.76, x.77)),
                                multp(multp(x.76, x.78), multp(x.77, PRF(x.64, x.65, x.66))))),
                     multp(x.75,
                           multp(PRF(x.64, x.65, x.66), multp(x.78, multp(x.76, x.77)))),
                     x.79),
                  x.80, H1(x.63), multp(PRF(x.64, x.65, x.66), H1(x.63)), x.63,
                  multp(randS1.49, H1(x.63)),
                  multp(randS1.49, multp(x.75, multp(x.78, multp(x.76, x.77)))),
                  x.82)
       ipk   = pk(x.70)
       randS1
             = randS1.49
       tsk   = PRF(x.64, x.65, x.66)
       z     = accept
       z.1   = multp(randS1.49, H1(x.63))
       z.2   = calcR2(minus(multp(s(randS1.49, PRF(x.64, x.65, x.66)),
                                  multp(x.67, multp(x.70, multp(x.68, x.69)))),
                            multp(H4(H3(multp(x.75, multp(x.76, x.77)),
                                        multp(x.75, multp(x.78, multp(x.76, x.77))),
                                        multp(x.75,
                                              plus(multp(x.78, multp(x.76, x.77)),
                                                   multp(multp(x.76, x.78),
                                                         multp(x.77, PRF(x.64, x.65, x.66))))),
                                        multp(x.75,
                                              multp(PRF(x.64, x.65, x.66),
                                                    multp(x.78, multp(x.76, x.77)))),
                                        x.79),
                                     x.80, H1(x.63), multp(PRF(x.64, x.65, x.66), H1(x.63)), x.63,
                                     multp(randS1.49, H1(x.63)),
                                     multp(randS1.49, multp(x.75, multp(x.78, multp(x.76, x.77)))),
                                     x.82),
                                  multp(x.67,
                                        multp(PRF(x.71, x.72, x.73),
                                              multp(x.70, multp(x.68, x.69)))))))
    
    7. J     = H1(x.88)
       K     = multp(PRF(x.89, x.90, x.91), H1(x.88))
       R     = R.54
       S     = multp(x.93, multp(x.94, multp(x.95, x.96)))
       T     = T.56
       W     = multp(x.93,
                     multp(PRF(x.89, x.90, x.91), multp(x.94, multp(x.95, x.96))))
       h     = H4(H3(multp(x.93, multp(x.95, x.96)),
                     multp(x.93, multp(x.94, multp(x.95, x.96))),
                     multp(x.93,
                           plus(multp(x.94, multp(x.95, x.96)),
                                multp(multp(x.95, x.94), multp(x.96, PRF(x.89, x.90, x.91))))),
                     multp(x.93,
                           multp(PRF(x.89, x.90, x.91), multp(x.94, multp(x.95, x.96)))),
                     x.99),
                  x.100, H1(x.88), multp(PRF(x.89, x.90, x.91), H1(x.88)), x.88,
                  multp(randS1.64, H1(x.88)),
                  multp(randS1.64, multp(x.93, multp(x.94, multp(x.95, x.96)))),
                  x.102)
       ipk   = ipk.60
       randS1
             = randS1.64
       tsk   = PRF(x.89, x.90, x.91)
       z     = verifyBlindCre(R.54,
                              multp(x.93, multp(x.94, multp(x.95, x.96))), T.56,
                              multp(x.93,
                                    multp(PRF(x.89, x.90, x.91), multp(x.94, multp(x.95, x.96)))),
                              ipk.60)
       z.1   = multp(randS1.64, H1(x.88))
       z.2   = multp(randS1.64,
                     multp(x.93, multp(x.94, multp(x.95, x.96))))
    
    8. J     = H1(x.90)
       K     = multp(PRF(x.91, x.92, x.93), H1(x.90))
       R     = R.56
       S     = S.57
       T     = T.58
       W     = W.59
       h     = H4(H3(multp(x.99, multp(x.100, x.101)),
                     multp(x.99, multp(x.102, multp(x.100, x.101))),
                     multp(x.99,
                           plus(multp(x.102, multp(x.100, x.101)),
                                multp(multp(x.100, x.102), multp(x.101, PRF(x.91, x.92, x.93))))),
                     multp(x.99,
                           multp(PRF(x.91, x.92, x.93), multp(x.102, multp(x.100, x.101)))),
                     x.103),
                  x.104, H1(x.90), multp(PRF(x.91, x.92, x.93), H1(x.90)), x.90,
                  multp(randS1.66, H1(x.90)),
                  multp(randS1.66, multp(x.99, multp(x.102, multp(x.100, x.101)))),
                  x.106)
       ipk   = ipk.62
       randS1
             = randS1.66
       tsk   = PRF(x.91, x.92, x.93)
       z     = verifyBlindCre(R.56, S.57, T.58, W.59, ipk.62)
       z.1   = multp(randS1.66, H1(x.90))
       z.2   = calcR2(minus(multp(s(randS1.66, PRF(x.91, x.92, x.93)),
                                  S.57),
                            multp(H4(H3(multp(x.99, multp(x.100, x.101)),
                                        multp(x.99, multp(x.102, multp(x.100, x.101))),
                                        multp(x.99,
                                              plus(multp(x.102, multp(x.100, x.101)),
                                                   multp(multp(x.100, x.102),
                                                         multp(x.101, PRF(x.91, x.92, x.93))))),
                                        multp(x.99,
                                              multp(PRF(x.91, x.92, x.93),
                                                    multp(x.102, multp(x.100, x.101)))),
                                        x.103),
                                     x.104, H1(x.90), multp(PRF(x.91, x.92, x.93), H1(x.90)), x.90,
                                     multp(randS1.66, H1(x.90)),
                                     multp(randS1.66,
                                           multp(x.99, multp(x.102, multp(x.100, x.101)))),
                                     x.106),
                                  W.59)))
  */

rule (modulo E) LINK:
   [
   Sigma( <'sigma', R, S, T, W, J, K, h, s(randS1, tsk), nv, nt> ),
   Sigma( <'sigma', RP, SP, TP, WP, JP, KP, hP, ssP, nvP, ntP> )
   ]
  --[ CompareLinkTokens( K, KP, J, JP ) ]->
   [ ]

  /* has exactly the trivial AC variant */

rule (modulo E) DEANONYMISE:
   [
   In( <'sigma', m, 'sigma', R, S, T, W, J, K, h, s(randS1, tsk), nv, 
        nt>
   ),
   !F_BSN( $I, bsn ), !F_IssuerPK( $I, ipk ),
   !RevealedPSTsk( $PS, tsk1 )
   ]
  --[
  Eq( verifyBlindCre(R, S, T, W, ipk), accept ),
  Eq( H4(H3(R, S, T, W, nv), m, J, K, bsn,
         calcR1(minus(multp(s(randS1, tsk), J), multp(h, K))),
         calcR2(minus(multp(s(randS1, tsk), S), multp(h, W))), nt),
      h
  ),
  Eq( checkAnon(S, W, J, K, tsk1), deanon ),
  DeAnonymised( $PS, tsk1,
                <'sigma', R, S, T, W, J, K, h, s(randS1, tsk), nv, nt>
  )
  ]->
   [ ]

  /*
  rule (modulo AC) DEANONYMISE:
     [
     In( <'sigma', m, 'sigma', R, S, T, W, J, K, h, s(randS1, tsk), nv, 
          nt>
     ),
     !F_BSN( $I, bsn ), !F_IssuerPK( $I, ipk ),
     !RevealedPSTsk( $PS, tsk1 )
     ]
    --[
    Eq( z, accept ),
    Eq( H4(H3(R, S, T, W, nv), m, J, K, bsn, z.1, z.2, nt), h ),
    Eq( z.3, deanon ),
    DeAnonymised( $PS, tsk1,
                  <'sigma', R, S, T, W, J, K, h, s(randS1, tsk), nv, nt>
    )
    ]->
     [ ]
    variants (modulo AC)
     1. J     = J.24
        K     = K.25
        R     = R.26
        S     = S.27
        T     = T.28
        W     = W.29
        h     = h.31
        ipk   = ipk.32
        randS1
              = randS1.36
        tsk   = tsk.37
        tsk1  = tsk1.38
        z     = verifyBlindCre(R.26, S.27, T.28, W.29, ipk.32)
        z.1   = calcR1(minus(multp(s(randS1.36, tsk.37), J.24),
                             multp(h.31, K.25)))
        z.2   = calcR2(minus(multp(s(randS1.36, tsk.37), S.27),
                             multp(h.31, W.29)))
        z.3   = checkAnon(S.27, W.29, J.24, K.25, tsk1.38)
    
     2. J     = J.31
        K     = K.32
        R     = multp(x.51, multp(x.52, x.53))
        S     = multp(x.51, multp(x.54, multp(x.52, x.53)))
        T     = multp(x.51,
                      plus(multp(x.54, multp(x.52, x.53)),
                           multp(multp(x.52, x.54), multp(x.53, PRF(x.55, x.56, x.57)))))
        W     = multp(x.51,
                      multp(PRF(x.55, x.56, x.57), multp(x.54, multp(x.52, x.53))))
        h     = h.38
        ipk   = pk(x.54)
        randS1
              = randS1.43
        tsk   = tsk.44
        tsk1  = tsk1.45
        z     = accept
        z.1   = calcR1(minus(multp(s(randS1.43, tsk.44), J.31),
                             multp(h.38, K.32)))
        z.2   = calcR2(minus(multp(s(randS1.43, tsk.44),
                                   multp(x.51, multp(x.54, multp(x.52, x.53)))),
                             multp(h.38,
                                   multp(x.51,
                                         multp(PRF(x.55, x.56, x.57),
                                               multp(x.54, multp(x.52, x.53)))))))
        z.3   = checkAnon(multp(x.51, multp(x.54, multp(x.52, x.53))),
                          multp(x.51,
                                multp(PRF(x.55, x.56, x.57), multp(x.54, multp(x.52, x.53)))),
                          J.31, K.32, tsk1.45)
    
     3. J     = J.37
        K     = K.38
        R     = multp(x.57, multp(x.58, x.59))
        S     = multp(x.57, multp(x.60, multp(x.58, x.59)))
        T     = multp(x.57,
                      plus(multp(x.60, multp(x.58, x.59)),
                           multp(multp(x.58, x.60), multp(x.59, PRF(x.61, x.62, x.63)))))
        W     = multp(x.57,
                      multp(PRF(x.61, x.62, x.63), multp(x.60, multp(x.58, x.59))))
        h     = H4(H3(multp(x.57, multp(x.58, x.59)),
                      multp(x.57, multp(x.60, multp(x.58, x.59))),
                      multp(x.57,
                            plus(multp(x.60, multp(x.58, x.59)),
                                 multp(multp(x.58, x.60), multp(x.59, PRF(x.61, x.62, x.63))))),
                      multp(x.57,
                            multp(PRF(x.61, x.62, x.63), multp(x.60, multp(x.58, x.59)))),
                      x.65),
                   x.66, H1(x.67), multp(PRF(x.61, x.62, x.63), H1(x.67)), x.67,
                   multp(randS1.49, H1(x.67)),
                   multp(randS1.49, multp(x.57, multp(x.60, multp(x.58, x.59)))),
                   x.69)
        ipk   = pk(x.60)
        randS1
              = randS1.49
        tsk   = PRF(x.61, x.62, x.63)
        tsk1  = tsk1.51
        z     = accept
        z.1   = calcR1(minus(multp(s(randS1.49, PRF(x.61, x.62, x.63)),
                                   J.37),
                             multp(H4(H3(multp(x.57, multp(x.58, x.59)),
                                         multp(x.57, multp(x.60, multp(x.58, x.59))),
                                         multp(x.57,
                                               plus(multp(x.60, multp(x.58, x.59)),
                                                    multp(multp(x.58, x.60),
                                                          multp(x.59, PRF(x.61, x.62, x.63))))),
                                         multp(x.57,
                                               multp(PRF(x.61, x.62, x.63),
                                                     multp(x.60, multp(x.58, x.59)))),
                                         x.65),
                                      x.66, H1(x.67), multp(PRF(x.61, x.62, x.63), H1(x.67)), x.67,
                                      multp(randS1.49, H1(x.67)),
                                      multp(randS1.49, multp(x.57, multp(x.60, multp(x.58, x.59)))),
                                      x.69),
                                   K.38)))
        z.2   = multp(randS1.49,
                      multp(x.57, multp(x.60, multp(x.58, x.59))))
        z.3   = checkAnon(multp(x.57, multp(x.60, multp(x.58, x.59))),
                          multp(x.57,
                                multp(PRF(x.61, x.62, x.63), multp(x.60, multp(x.58, x.59)))),
                          J.37, K.38, tsk1.51)
    
     4. J     = J.38
        K     = K.39
        R     = R.40
        S     = multp(x.58, multp(x.59, multp(x.60, x.61)))
        T     = T.42
        W     = multp(x.58,
                      multp(PRF(x.63, x.64, x.65), multp(x.59, multp(x.60, x.61))))
        h     = H4(H3(multp(x.58, multp(x.60, x.61)),
                      multp(x.58, multp(x.59, multp(x.60, x.61))),
                      multp(x.58,
                            plus(multp(x.59, multp(x.60, x.61)),
                                 multp(multp(x.60, x.59), multp(x.61, PRF(x.63, x.64, x.65))))),
                      multp(x.58,
                            multp(PRF(x.63, x.64, x.65), multp(x.59, multp(x.60, x.61)))),
                      x.67),
                   x.68, H1(x.69), multp(PRF(x.63, x.64, x.65), H1(x.69)), x.69,
                   multp(randS1.50, H1(x.69)),
                   multp(randS1.50, multp(x.58, multp(x.59, multp(x.60, x.61)))),
                   x.71)
        ipk   = ipk.46
        randS1
              = randS1.50
        tsk   = PRF(x.63, x.64, x.65)
        tsk1  = tsk1.52
        z     = verifyBlindCre(R.40,
                               multp(x.58, multp(x.59, multp(x.60, x.61))), T.42,
                               multp(x.58,
                                     multp(PRF(x.63, x.64, x.65), multp(x.59, multp(x.60, x.61)))),
                               ipk.46)
        z.1   = calcR1(minus(multp(s(randS1.50, PRF(x.63, x.64, x.65)),
                                   J.38),
                             multp(H4(H3(multp(x.58, multp(x.60, x.61)),
                                         multp(x.58, multp(x.59, multp(x.60, x.61))),
                                         multp(x.58,
                                               plus(multp(x.59, multp(x.60, x.61)),
                                                    multp(multp(x.60, x.59),
                                                          multp(x.61, PRF(x.63, x.64, x.65))))),
                                         multp(x.58,
                                               multp(PRF(x.63, x.64, x.65),
                                                     multp(x.59, multp(x.60, x.61)))),
                                         x.67),
                                      x.68, H1(x.69), multp(PRF(x.63, x.64, x.65), H1(x.69)), x.69,
                                      multp(randS1.50, H1(x.69)),
                                      multp(randS1.50, multp(x.58, multp(x.59, multp(x.60, x.61)))),
                                      x.71),
                                   K.39)))
        z.2   = multp(randS1.50,
                      multp(x.58, multp(x.59, multp(x.60, x.61))))
        z.3   = checkAnon(multp(x.58, multp(x.59, multp(x.60, x.61))),
                          multp(x.58,
                                multp(PRF(x.63, x.64, x.65), multp(x.59, multp(x.60, x.61)))),
                          J.38, K.39, tsk1.52)
    
     5. J     = H1(x.44)
        K     = multp(PRF(x.45, x.46, x.47), H1(x.44))
        R     = multp(x.48, multp(x.49, x.50))
        S     = multp(x.48, multp(x.51, multp(x.49, x.50)))
        T     = multp(x.48,
                      plus(multp(x.51, multp(x.49, x.50)),
                           multp(multp(x.49, x.51), multp(x.50, PRF(x.45, x.46, x.47)))))
        W     = multp(x.48,
                      multp(PRF(x.45, x.46, x.47), multp(x.51, multp(x.49, x.50))))
        h     = H4(H3(multp(x.48, multp(x.49, x.50)),
                      multp(x.48, multp(x.51, multp(x.49, x.50))),
                      multp(x.48,
                            plus(multp(x.51, multp(x.49, x.50)),
                                 multp(multp(x.49, x.51), multp(x.50, PRF(x.45, x.46, x.47))))),
                      multp(x.48,
                            multp(PRF(x.45, x.46, x.47), multp(x.51, multp(x.49, x.50)))),
                      x.53),
                   x.54, H1(x.44), multp(PRF(x.45, x.46, x.47), H1(x.44)), x.44,
                   multp(randS1.36, H1(x.44)),
                   multp(randS1.36, multp(x.48, multp(x.51, multp(x.49, x.50)))),
                   x.56)
        ipk   = pk(x.51)
        randS1
              = randS1.36
        tsk   = PRF(x.45, x.46, x.47)
        tsk1  = PRF(x.45, x.46, x.47)
        z     = accept
        z.1   = multp(randS1.36, H1(x.44))
        z.2   = multp(randS1.36,
                      multp(x.48, multp(x.51, multp(x.49, x.50))))
        z.3   = deanon
    
     6. J     = H1(x.45)
        K     = multp(PRF(x.46, x.47, x.48), H1(x.45))
        R     = multp(x.49, multp(x.50, x.51))
        S     = multp(x.49, multp(x.52, multp(x.50, x.51)))
        T     = multp(x.49,
                      plus(multp(x.52, multp(x.50, x.51)),
                           multp(multp(x.50, x.52), multp(x.51, PRF(x.46, x.47, x.48)))))
        W     = multp(x.49,
                      multp(PRF(x.46, x.47, x.48), multp(x.52, multp(x.50, x.51))))
        h     = h.32
        ipk   = pk(x.52)
        randS1
              = randS1.37
        tsk   = tsk.38
        tsk1  = PRF(x.46, x.47, x.48)
        z     = accept
        z.1   = calcR1(minus(multp(s(randS1.37, tsk.38), H1(x.45)),
                             multp(h.32, multp(PRF(x.46, x.47, x.48), H1(x.45)))))
        z.2   = calcR2(minus(multp(s(randS1.37, tsk.38),
                                   multp(x.49, multp(x.52, multp(x.50, x.51)))),
                             multp(h.32,
                                   multp(x.49,
                                         multp(PRF(x.46, x.47, x.48),
                                               multp(x.52, multp(x.50, x.51)))))))
        z.3   = deanon
    
     7. J     = H1(x.45)
        K     = multp(PRF(x.46, x.47, x.48), H1(x.45))
        R     = multp(x.49, multp(x.50, x.51))
        S     = multp(x.49, multp(x.52, multp(x.50, x.51)))
        T     = multp(x.49,
                      plus(multp(x.52, multp(x.50, x.51)),
                           multp(multp(x.50, x.52), multp(x.51, PRF(x.46, x.47, x.48)))))
        W     = multp(x.49,
                      multp(PRF(x.46, x.47, x.48), multp(x.52, multp(x.50, x.51))))
        h     = H4(H3(multp(x.49, multp(x.50, x.51)),
                      multp(x.49, multp(x.52, multp(x.50, x.51))),
                      multp(x.49,
                            plus(multp(x.52, multp(x.50, x.51)),
                                 multp(multp(x.50, x.52), multp(x.51, PRF(x.46, x.47, x.48))))),
                      multp(x.49,
                            multp(PRF(x.46, x.47, x.48), multp(x.52, multp(x.50, x.51)))),
                      x.54),
                   x.55, H1(x.45), multp(PRF(x.46, x.47, x.48), H1(x.45)), x.45,
                   multp(randS1.37, H1(x.45)),
                   multp(randS1.37, multp(x.49, multp(x.52, multp(x.50, x.51)))),
                   x.57)
        ipk   = pk(x.52)
        randS1
              = randS1.37
        tsk   = PRF(x.46, x.47, x.48)
        tsk1  = tsk1.39
        z     = accept
        z.1   = multp(randS1.37, H1(x.45))
        z.2   = multp(randS1.37,
                      multp(x.49, multp(x.52, multp(x.50, x.51))))
        z.3   = checkAnon(multp(x.49, multp(x.52, multp(x.50, x.51))),
                          multp(x.49,
                                multp(PRF(x.46, x.47, x.48), multp(x.52, multp(x.50, x.51)))),
                          H1(x.45), multp(PRF(x.46, x.47, x.48), H1(x.45)), tsk1.39)
    
     8. J     = H1(x.45)
        K     = multp(PRF(x.46, x.47, x.48), H1(x.45))
        R     = multp(x.49, multp(x.50, x.51))
        S     = multp(x.49, multp(x.52, multp(x.50, x.51)))
        T     = multp(x.49,
                      plus(multp(x.52, multp(x.50, x.51)),
                           multp(multp(x.50, x.52), multp(x.51, PRF(x.46, x.47, x.48)))))
        W     = multp(x.49,
                      multp(PRF(x.46, x.47, x.48), multp(x.52, multp(x.50, x.51))))
        h     = H4(H3(multp(x.49, multp(x.50, x.51)),
                      multp(x.49, multp(x.52, multp(x.50, x.51))),
                      multp(x.49,
                            plus(multp(x.52, multp(x.50, x.51)),
                                 multp(multp(x.50, x.52), multp(x.51, PRF(x.46, x.47, x.48))))),
                      multp(x.49,
                            multp(PRF(x.46, x.47, x.48), multp(x.52, multp(x.50, x.51)))),
                      x.54),
                   x.55, H1(x.56), multp(PRF(x.46, x.47, x.48), H1(x.56)), x.56,
                   multp(randS1.37, H1(x.56)),
                   multp(randS1.37, multp(x.49, multp(x.52, multp(x.50, x.51)))),
                   x.58)
        ipk   = pk(x.52)
        randS1
              = randS1.37
        tsk   = PRF(x.46, x.47, x.48)
        tsk1  = PRF(x.46, x.47, x.48)
        z     = accept
        z.1   = calcR1(minus(multp(s(randS1.37, PRF(x.46, x.47, x.48)),
                                   H1(x.45)),
                             multp(H4(H3(multp(x.49, multp(x.50, x.51)),
                                         multp(x.49, multp(x.52, multp(x.50, x.51))),
                                         multp(x.49,
                                               plus(multp(x.52, multp(x.50, x.51)),
                                                    multp(multp(x.50, x.52),
                                                          multp(x.51, PRF(x.46, x.47, x.48))))),
                                         multp(x.49,
                                               multp(PRF(x.46, x.47, x.48),
                                                     multp(x.52, multp(x.50, x.51)))),
                                         x.54),
                                      x.55, H1(x.56), multp(PRF(x.46, x.47, x.48), H1(x.56)), x.56,
                                      multp(randS1.37, H1(x.56)),
                                      multp(randS1.37, multp(x.49, multp(x.52, multp(x.50, x.51)))),
                                      x.58),
                                   multp(PRF(x.46, x.47, x.48), H1(x.45)))))
        z.2   = multp(randS1.37,
                      multp(x.49, multp(x.52, multp(x.50, x.51))))
        z.3   = deanon
    
     9. J     = H1(x.48)
        K     = multp(PRF(x.49, x.50, x.51), H1(x.48))
        R     = multp(x.52, multp(x.53, x.54))
        S     = multp(x.52, multp(x.55, multp(x.53, x.54)))
        T     = multp(x.52,
                      plus(multp(x.55, multp(x.53, x.54)),
                           multp(multp(x.53, x.55), multp(x.54, PRF(x.49, x.50, x.51)))))
        W     = multp(x.52,
                      multp(PRF(x.49, x.50, x.51), multp(x.55, multp(x.53, x.54))))
        h     = H4(H3(multp(x.57, multp(x.58, x.59)),
                      multp(x.57, multp(x.60, multp(x.58, x.59))),
                      multp(x.57,
                            plus(multp(x.60, multp(x.58, x.59)),
                                 multp(multp(x.58, x.60), multp(x.59, PRF(x.49, x.50, x.51))))),
                      multp(x.57,
                            multp(PRF(x.49, x.50, x.51), multp(x.60, multp(x.58, x.59)))),
                      x.61),
                   x.62, H1(x.48), multp(PRF(x.49, x.50, x.51), H1(x.48)), x.48,
                   multp(randS1.40, H1(x.48)),
                   multp(randS1.40, multp(x.57, multp(x.60, multp(x.58, x.59)))),
                   x.64)
        ipk   = pk(x.55)
        randS1
              = randS1.40
        tsk   = PRF(x.49, x.50, x.51)
        tsk1  = PRF(x.49, x.50, x.51)
        z     = accept
        z.1   = multp(randS1.40, H1(x.48))
        z.2   = calcR2(minus(multp(s(randS1.40, PRF(x.49, x.50, x.51)),
                                   multp(x.52, multp(x.55, multp(x.53, x.54)))),
                             multp(H4(H3(multp(x.57, multp(x.58, x.59)),
                                         multp(x.57, multp(x.60, multp(x.58, x.59))),
                                         multp(x.57,
                                               plus(multp(x.60, multp(x.58, x.59)),
                                                    multp(multp(x.58, x.60),
                                                          multp(x.59, PRF(x.49, x.50, x.51))))),
                                         multp(x.57,
                                               multp(PRF(x.49, x.50, x.51),
                                                     multp(x.60, multp(x.58, x.59)))),
                                         x.61),
                                      x.62, H1(x.48), multp(PRF(x.49, x.50, x.51), H1(x.48)), x.48,
                                      multp(randS1.40, H1(x.48)),
                                      multp(randS1.40, multp(x.57, multp(x.60, multp(x.58, x.59)))),
                                      x.64),
                                   multp(x.52,
                                         multp(PRF(x.49, x.50, x.51),
                                               multp(x.55, multp(x.53, x.54)))))))
        z.3   = deanon
    
    10. J     = H1(x.51)
        K     = multp(PRF(x.52, x.53, x.54), H1(x.51))
        R     = R.33
        S     = multp(x.56, multp(x.57, multp(x.58, x.59)))
        T     = T.35
        W     = multp(x.56,
                      multp(PRF(x.52, x.53, x.54), multp(x.57, multp(x.58, x.59))))
        h     = h.38
        ipk   = ipk.39
        randS1
              = randS1.43
        tsk   = tsk.44
        tsk1  = PRF(x.52, x.53, x.54)
        z     = verifyBlindCre(R.33,
                               multp(x.56, multp(x.57, multp(x.58, x.59))), T.35,
                               multp(x.56,
                                     multp(PRF(x.52, x.53, x.54), multp(x.57, multp(x.58, x.59)))),
                               ipk.39)
        z.1   = calcR1(minus(multp(s(randS1.43, tsk.44), H1(x.51)),
                             multp(h.38, multp(PRF(x.52, x.53, x.54), H1(x.51)))))
        z.2   = calcR2(minus(multp(s(randS1.43, tsk.44),
                                   multp(x.56, multp(x.57, multp(x.58, x.59)))),
                             multp(h.38,
                                   multp(x.56,
                                         multp(PRF(x.52, x.53, x.54),
                                               multp(x.57, multp(x.58, x.59)))))))
        z.3   = deanon
    
    11. J     = H1(x.52)
        K     = multp(PRF(x.53, x.54, x.55), H1(x.52))
        R     = multp(x.56, multp(x.57, x.58))
        S     = multp(x.56, multp(x.59, multp(x.57, x.58)))
        T     = multp(x.56,
                      plus(multp(x.59, multp(x.57, x.58)),
                           multp(multp(x.57, x.59), multp(x.58, PRF(x.60, x.61, x.62)))))
        W     = multp(x.56,
                      multp(PRF(x.60, x.61, x.62), multp(x.59, multp(x.57, x.58))))
        h     = H4(H3(multp(x.64, multp(x.65, x.66)),
                      multp(x.64, multp(x.67, multp(x.65, x.66))),
                      multp(x.64,
                            plus(multp(x.67, multp(x.65, x.66)),
                                 multp(multp(x.65, x.67), multp(x.66, PRF(x.53, x.54, x.55))))),
                      multp(x.64,
                            multp(PRF(x.53, x.54, x.55), multp(x.67, multp(x.65, x.66)))),
                      x.68),
                   x.69, H1(x.52), multp(PRF(x.53, x.54, x.55), H1(x.52)), x.52,
                   multp(randS1.44, H1(x.52)),
                   multp(randS1.44, multp(x.64, multp(x.67, multp(x.65, x.66)))),
                   x.71)
        ipk   = pk(x.59)
        randS1
              = randS1.44
        tsk   = PRF(x.53, x.54, x.55)
        tsk1  = tsk1.46
        z     = accept
        z.1   = multp(randS1.44, H1(x.52))
        z.2   = calcR2(minus(multp(s(randS1.44, PRF(x.53, x.54, x.55)),
                                   multp(x.56, multp(x.59, multp(x.57, x.58)))),
                             multp(H4(H3(multp(x.64, multp(x.65, x.66)),
                                         multp(x.64, multp(x.67, multp(x.65, x.66))),
                                         multp(x.64,
                                               plus(multp(x.67, multp(x.65, x.66)),
                                                    multp(multp(x.65, x.67),
                                                          multp(x.66, PRF(x.53, x.54, x.55))))),
                                         multp(x.64,
                                               multp(PRF(x.53, x.54, x.55),
                                                     multp(x.67, multp(x.65, x.66)))),
                                         x.68),
                                      x.69, H1(x.52), multp(PRF(x.53, x.54, x.55), H1(x.52)), x.52,
                                      multp(randS1.44, H1(x.52)),
                                      multp(randS1.44, multp(x.64, multp(x.67, multp(x.65, x.66)))),
                                      x.71),
                                   multp(x.56,
                                         multp(PRF(x.60, x.61, x.62),
                                               multp(x.59, multp(x.57, x.58)))))))
        z.3   = checkAnon(multp(x.56, multp(x.59, multp(x.57, x.58))),
                          multp(x.56,
                                multp(PRF(x.60, x.61, x.62), multp(x.59, multp(x.57, x.58)))),
                          H1(x.52), multp(PRF(x.53, x.54, x.55), H1(x.52)), tsk1.46)
    
    12. J     = H1(x.57)
        K     = multp(PRF(x.58, x.59, x.60), H1(x.57))
        R     = R.39
        S     = multp(x.62, multp(x.63, multp(x.64, x.65)))
        T     = T.41
        W     = multp(x.62,
                      multp(PRF(x.58, x.59, x.60), multp(x.63, multp(x.64, x.65))))
        h     = H4(H3(multp(x.62, multp(x.64, x.65)),
                      multp(x.62, multp(x.63, multp(x.64, x.65))),
                      multp(x.62,
                            plus(multp(x.63, multp(x.64, x.65)),
                                 multp(multp(x.64, x.63), multp(x.65, PRF(x.58, x.59, x.60))))),
                      multp(x.62,
                            multp(PRF(x.58, x.59, x.60), multp(x.63, multp(x.64, x.65)))),
                      x.68),
                   x.69, H1(x.57), multp(PRF(x.58, x.59, x.60), H1(x.57)), x.57,
                   multp(randS1.49, H1(x.57)),
                   multp(randS1.49, multp(x.62, multp(x.63, multp(x.64, x.65)))),
                   x.71)
        ipk   = ipk.45
        randS1
              = randS1.49
        tsk   = PRF(x.58, x.59, x.60)
        tsk1  = tsk1.51
        z     = verifyBlindCre(R.39,
                               multp(x.62, multp(x.63, multp(x.64, x.65))), T.41,
                               multp(x.62,
                                     multp(PRF(x.58, x.59, x.60), multp(x.63, multp(x.64, x.65)))),
                               ipk.45)
        z.1   = multp(randS1.49, H1(x.57))
        z.2   = multp(randS1.49,
                      multp(x.62, multp(x.63, multp(x.64, x.65))))
        z.3   = checkAnon(multp(x.62, multp(x.63, multp(x.64, x.65))),
                          multp(x.62,
                                multp(PRF(x.58, x.59, x.60), multp(x.63, multp(x.64, x.65)))),
                          H1(x.57), multp(PRF(x.58, x.59, x.60), H1(x.57)), tsk1.51)
    
    13. J     = H1(x.57)
        K     = multp(PRF(x.58, x.59, x.60), H1(x.57))
        R     = R.39
        S     = multp(x.62, multp(x.63, multp(x.64, x.65)))
        T     = T.41
        W     = multp(x.62,
                      multp(PRF(x.58, x.59, x.60), multp(x.63, multp(x.64, x.65))))
        h     = H4(H3(multp(x.62, multp(x.64, x.65)),
                      multp(x.62, multp(x.63, multp(x.64, x.65))),
                      multp(x.62,
                            plus(multp(x.63, multp(x.64, x.65)),
                                 multp(multp(x.64, x.63), multp(x.65, PRF(x.58, x.59, x.60))))),
                      multp(x.62,
                            multp(PRF(x.58, x.59, x.60), multp(x.63, multp(x.64, x.65)))),
                      x.68),
                   x.69, H1(x.57), multp(PRF(x.58, x.59, x.60), H1(x.57)), x.57,
                   multp(randS1.49, H1(x.57)),
                   multp(randS1.49, multp(x.62, multp(x.63, multp(x.64, x.65)))),
                   x.71)
        ipk   = ipk.45
        randS1
              = randS1.49
        tsk   = PRF(x.58, x.59, x.60)
        tsk1  = PRF(x.58, x.59, x.60)
        z     = verifyBlindCre(R.39,
                               multp(x.62, multp(x.63, multp(x.64, x.65))), T.41,
                               multp(x.62,
                                     multp(PRF(x.58, x.59, x.60), multp(x.63, multp(x.64, x.65)))),
                               ipk.45)
        z.1   = multp(randS1.49, H1(x.57))
        z.2   = multp(randS1.49,
                      multp(x.62, multp(x.63, multp(x.64, x.65))))
        z.3   = deanon
    
    14. J     = H1(x.58)
        K     = multp(PRF(x.59, x.60, x.61), H1(x.58))
        R     = R.40
        S     = multp(x.63, multp(x.64, multp(x.65, x.66)))
        T     = T.42
        W     = multp(x.63,
                      multp(PRF(x.59, x.60, x.61), multp(x.64, multp(x.65, x.66))))
        h     = H4(H3(multp(x.63, multp(x.65, x.66)),
                      multp(x.63, multp(x.64, multp(x.65, x.66))),
                      multp(x.63,
                            plus(multp(x.64, multp(x.65, x.66)),
                                 multp(multp(x.65, x.64), multp(x.66, PRF(x.59, x.60, x.61))))),
                      multp(x.63,
                            multp(PRF(x.59, x.60, x.61), multp(x.64, multp(x.65, x.66)))),
                      x.69),
                   x.70, H1(x.71), multp(PRF(x.59, x.60, x.61), H1(x.71)), x.71,
                   multp(randS1.50, H1(x.71)),
                   multp(randS1.50, multp(x.63, multp(x.64, multp(x.65, x.66)))),
                   x.73)
        ipk   = ipk.46
        randS1
              = randS1.50
        tsk   = PRF(x.59, x.60, x.61)
        tsk1  = PRF(x.59, x.60, x.61)
        z     = verifyBlindCre(R.40,
                               multp(x.63, multp(x.64, multp(x.65, x.66))), T.42,
                               multp(x.63,
                                     multp(PRF(x.59, x.60, x.61), multp(x.64, multp(x.65, x.66)))),
                               ipk.46)
        z.1   = calcR1(minus(multp(s(randS1.50, PRF(x.59, x.60, x.61)),
                                   H1(x.58)),
                             multp(H4(H3(multp(x.63, multp(x.65, x.66)),
                                         multp(x.63, multp(x.64, multp(x.65, x.66))),
                                         multp(x.63,
                                               plus(multp(x.64, multp(x.65, x.66)),
                                                    multp(multp(x.65, x.64),
                                                          multp(x.66, PRF(x.59, x.60, x.61))))),
                                         multp(x.63,
                                               multp(PRF(x.59, x.60, x.61),
                                                     multp(x.64, multp(x.65, x.66)))),
                                         x.69),
                                      x.70, H1(x.71), multp(PRF(x.59, x.60, x.61), H1(x.71)), x.71,
                                      multp(randS1.50, H1(x.71)),
                                      multp(randS1.50, multp(x.63, multp(x.64, multp(x.65, x.66)))),
                                      x.73),
                                   multp(PRF(x.59, x.60, x.61), H1(x.58)))))
        z.2   = multp(randS1.50,
                      multp(x.63, multp(x.64, multp(x.65, x.66))))
        z.3   = deanon
    
    15. J     = H1(x.59)
        K     = multp(PRF(x.60, x.61, x.62), H1(x.59))
        R     = R.41
        S     = S.42
        T     = T.43
        W     = W.44
        h     = H4(H3(multp(x.68, multp(x.69, x.70)),
                      multp(x.68, multp(x.71, multp(x.69, x.70))),
                      multp(x.68,
                            plus(multp(x.71, multp(x.69, x.70)),
                                 multp(multp(x.69, x.71), multp(x.70, PRF(x.60, x.61, x.62))))),
                      multp(x.68,
                            multp(PRF(x.60, x.61, x.62), multp(x.71, multp(x.69, x.70)))),
                      x.72),
                   x.73, H1(x.59), multp(PRF(x.60, x.61, x.62), H1(x.59)), x.59,
                   multp(randS1.51, H1(x.59)),
                   multp(randS1.51, multp(x.68, multp(x.71, multp(x.69, x.70)))),
                   x.75)
        ipk   = ipk.47
        randS1
              = randS1.51
        tsk   = PRF(x.60, x.61, x.62)
        tsk1  = tsk1.53
        z     = verifyBlindCre(R.41, S.42, T.43, W.44, ipk.47)
        z.1   = multp(randS1.51, H1(x.59))
        z.2   = calcR2(minus(multp(s(randS1.51, PRF(x.60, x.61, x.62)),
                                   S.42),
                             multp(H4(H3(multp(x.68, multp(x.69, x.70)),
                                         multp(x.68, multp(x.71, multp(x.69, x.70))),
                                         multp(x.68,
                                               plus(multp(x.71, multp(x.69, x.70)),
                                                    multp(multp(x.69, x.71),
                                                          multp(x.70, PRF(x.60, x.61, x.62))))),
                                         multp(x.68,
                                               multp(PRF(x.60, x.61, x.62),
                                                     multp(x.71, multp(x.69, x.70)))),
                                         x.72),
                                      x.73, H1(x.59), multp(PRF(x.60, x.61, x.62), H1(x.59)), x.59,
                                      multp(randS1.51, H1(x.59)),
                                      multp(randS1.51, multp(x.68, multp(x.71, multp(x.69, x.70)))),
                                      x.75),
                                   W.44)))
        z.3   = checkAnon(S.42, W.44, H1(x.59),
                          multp(PRF(x.60, x.61, x.62), H1(x.59)), tsk1.53)
    
    16. J     = H1(x.61)
        K     = multp(PRF(x.62, x.63, x.64), H1(x.61))
        R     = R.43
        S     = multp(x.66, multp(x.67, multp(x.68, x.69)))
        T     = T.45
        W     = multp(x.66,
                      multp(PRF(x.62, x.63, x.64), multp(x.67, multp(x.68, x.69))))
        h     = H4(H3(multp(x.72, multp(x.73, x.74)),
                      multp(x.72, multp(x.75, multp(x.73, x.74))),
                      multp(x.72,
                            plus(multp(x.75, multp(x.73, x.74)),
                                 multp(multp(x.73, x.75), multp(x.74, PRF(x.62, x.63, x.64))))),
                      multp(x.72,
                            multp(PRF(x.62, x.63, x.64), multp(x.75, multp(x.73, x.74)))),
                      x.76),
                   x.77, H1(x.61), multp(PRF(x.62, x.63, x.64), H1(x.61)), x.61,
                   multp(randS1.53, H1(x.61)),
                   multp(randS1.53, multp(x.72, multp(x.75, multp(x.73, x.74)))),
                   x.79)
        ipk   = ipk.49
        randS1
              = randS1.53
        tsk   = PRF(x.62, x.63, x.64)
        tsk1  = PRF(x.62, x.63, x.64)
        z     = verifyBlindCre(R.43,
                               multp(x.66, multp(x.67, multp(x.68, x.69))), T.45,
                               multp(x.66,
                                     multp(PRF(x.62, x.63, x.64), multp(x.67, multp(x.68, x.69)))),
                               ipk.49)
        z.1   = multp(randS1.53, H1(x.61))
        z.2   = calcR2(minus(multp(s(randS1.53, PRF(x.62, x.63, x.64)),
                                   multp(x.66, multp(x.67, multp(x.68, x.69)))),
                             multp(H4(H3(multp(x.72, multp(x.73, x.74)),
                                         multp(x.72, multp(x.75, multp(x.73, x.74))),
                                         multp(x.72,
                                               plus(multp(x.75, multp(x.73, x.74)),
                                                    multp(multp(x.73, x.75),
                                                          multp(x.74, PRF(x.62, x.63, x.64))))),
                                         multp(x.72,
                                               multp(PRF(x.62, x.63, x.64),
                                                     multp(x.75, multp(x.73, x.74)))),
                                         x.76),
                                      x.77, H1(x.61), multp(PRF(x.62, x.63, x.64), H1(x.61)), x.61,
                                      multp(randS1.53, H1(x.61)),
                                      multp(randS1.53, multp(x.72, multp(x.75, multp(x.73, x.74)))),
                                      x.79),
                                   multp(x.66,
                                         multp(PRF(x.62, x.63, x.64),
                                               multp(x.67, multp(x.68, x.69)))))))
        z.3   = deanon
  */

lemma functional_correctness:
  exists-trace
  "∃ #a #i #j #k #l #m #n #o #p #q #r #s #t #u.
    (((((((((((((((((((((((((((((((¬(∃ C #k1.
                                      IssuerKeyReveal( C ) @ #k1)) ∧
                                  (¬(∃ C #k2. RevealEK( C ) @ #k2))) ∧
                                 (¬(∃ C #k3. RevealTsk( C ) @ #k3))) ∧
                                (PlatformInit( ) @ #a)) ∧
                               (IssuerJoinOne( ) @ #i)) ∧
                              (ASJoinOne( ) @ #j)) ∧
                             (PSJoinOne( ) @ #k)) ∧
                            (ASJoinTwo( ) @ #l)) ∧
                           (IssuerJoinTwo( ) @ #m)) ∧
                          (ASJoinThree( ) @ #n)) ∧
                         (PSJoinTwo( ) @ #o)) ∧
                        (ASJoinFour( ) @ #p)) ∧
                       (VerifierSignOne( ) @ #q)) ∧
                      (ASSignOne( ) @ #r)) ∧
                     (PSSignOne( ) @ #s)) ∧
                    (ASSignTwo( ) @ #t)) ∧
                   (VerifierVerifyOneWS( ) @ #u)) ∧
                  (#a < #i)) ∧
                 (#i < #j)) ∧
                (#j < #k)) ∧
               (#k < #l)) ∧
              (#l < #m)) ∧
             (#m < #n)) ∧
            (#n < #o)) ∧
           (#o < #p)) ∧
          (#p < #q)) ∧
         (#q < #r)) ∧
        (#r < #s)) ∧
       (#s < #t)) ∧
      (#t < #u)) ∧
     (∀ #i.1 #j.1 x.
       ((UniqueExecJoin( x ) @ #i.1) ∧ (UniqueExecJoin( x ) @ #j.1)) ⇒
       (#i.1 = #j.1))) ∧
    (∀ #i.1 #j.1 x.
      ((UniqueExecSign( x ) @ #i.1) ∧ (UniqueExecSign( x ) @ #j.1)) ⇒
      (#i.1 = #j.1))"
/*
guarded formula characterizing all satisfying traces:
"∃ #a #i #j #k #l #m #n #o #p #q #r #s #t #u.
  (PlatformInit( ) @ #a) ∧
  (IssuerJoinOne( ) @ #i) ∧
  (ASJoinOne( ) @ #j) ∧
  (PSJoinOne( ) @ #k) ∧
  (ASJoinTwo( ) @ #l) ∧
  (IssuerJoinTwo( ) @ #m) ∧
  (ASJoinThree( ) @ #n) ∧
  (PSJoinTwo( ) @ #o) ∧
  (ASJoinFour( ) @ #p) ∧
  (VerifierSignOne( ) @ #q) ∧
  (ASSignOne( ) @ #r) ∧
  (PSSignOne( ) @ #s) ∧
  (ASSignTwo( ) @ #t) ∧
  (VerifierVerifyOneWS( ) @ #u)
 ∧
  (∀ C #k1. (IssuerKeyReveal( C ) @ #k1) ⇒ ⊥) ∧
  (∀ C #k2. (RevealEK( C ) @ #k2) ⇒ ⊥) ∧
  (∀ C #k3. (RevealTsk( C ) @ #k3) ⇒ ⊥) ∧
  (#a < #i) ∧
  (#i < #j) ∧
  (#j < #k) ∧
  (#k < #l) ∧
  (#l < #m) ∧
  (#m < #n) ∧
  (#n < #o) ∧
  (#o < #p) ∧
  (#p < #q) ∧
  (#q < #r) ∧
  (#r < #s) ∧
  (#s < #t) ∧
  (#t < #u) ∧
  (∀ #i.1 #j.1 x.
    (UniqueExecJoin( x ) @ #i.1) ∧ (UniqueExecJoin( x ) @ #j.1)
   ⇒
    #i.1 = #j.1) ∧
  (∀ #i.1 #j.1 x.
    (UniqueExecSign( x ) @ #i.1) ∧ (UniqueExecSign( x ) @ #j.1)
   ⇒
    #i.1 = #j.1)"
*/
simplify
solve( !F_PSPkEk( $PS.1, pk_ek ) ▶₂ #i )
  case PLATFORM_SETUP
  solve( !F_IssuerPK( $I, ipk ) ▶₃ #i )
    case ISSUER_SETUP
    solve( !F_IssuerKi( $I.1, Ki ) ▶₃ #k )
      case ISSUER_SETUP
      solve( !F_PSEk( $PS.2, sk_ek.1 ) ▶₄ #k )
        case PLATFORM_SETUP
        solve( !F_IssuerPK( $I, ipk ) ▶₅ #k )
          case ISSUER_SETUP
          solve( !F_IssuerGenerator( $I, P1 ) ▶₆ #k )
            case ISSUER_SETUP
            solve( !F_IssuerSK( $I.1, isk.1 ) ▶₃ #m )
              case ISSUER_SETUP
              solve( !F_IssuerPK( $I, pk(x.4) ) ▶₄ #m )
                case ISSUER_SETUP
                solve( !F_IssuerGenerator( $I, P1.1 ) ▶₅ #m )
                  case ISSUER_SETUP
                  solve( !F_PSPkEk( $PS.3, pk_ek.1 ) ▶₆ #m )
                    case PLATFORM_SETUP
                    solve( !F_PSEk( $PS.4, sk_ek.1 ) ▶₁ #o )
                      case PLATFORM_SETUP
                      solve( !F_PSTsk( $PS, PRF(DAASeed.1, Ki.1, cnt.1) ) ▶₂ #o )
                        case PS_JOIN_ONE
                        solve( !F_IssuerPK( $I.1, pk(x.6) ) ▶₁ #p )
                          case ISSUER_SETUP
                          solve( !F_BSN( $I.1, bsn ) ▶₁ #r )
                            case ISSUER_SETUP
                            solve( !F_ASCre( $AS.8, $PS.5, <A.1, B.1, C.1, D> ) ▶₃ #r )
                              case AS_JOIN_FOUR
                              solve( !F_PSTsk( $PS.5, PRF(DAASeed.1, Ki.1, cnt.1) ) ▶₃ #s )
                                case PS_JOIN_ONE
                                solve( !F_BSN( $I.1, bsn.3 ) ▶₂ #u.1 )
                                  case ISSUER_SETUP
                                  solve( !F_IssuerPK( $I, pk(x.12) ) ▶₃ #u.1 )
                                    case ISSUER_SETUP
                                    solve( St_PlatformInit( $AS.1, $PS ) ▶₄ #i )
                                      case PLATFORM_SETUP
                                      solve( In_S( $PS.2, $AS.3, <'PS_RESP_OUT', Q2, v, w, gamma>
                                             ) ▶₀ #l )
                                        case ChanIn_S
                                        solve( St_ISSUER_JOIN_ONE( $I, $PS, km.3, ni.3 ) ▶₁ #m )
                                          case ISSUER_JOIN_ONE
                                          solve( In_S( $PS.4, $AS.6,
                                                       <~sid.2, 'PSSignResp', K, h, 
                                                        s(~randS1.1, tsk), ~nt.1>
                                                 ) ▶₀ #t )
                                            case ChanIn_S
                                            solve( St_AS_SIGN_ONE( ~sid.1, $AS, R.1, S.1, T.1, W.1,
                                                                   H1(bsn.2), nv.3, m.4
                                                   ) ▶₁ #t )
                                              case AS_SIGN_ONE
                                              solve( St_VERIFIER_SIGN_1( $V.1, nv.3, m.4 ) ▶₁ #u.1 )
                                                case VERIFIER_SIGN_ONE
                                                solve( !KU( MAC(<'gamma', ~P1, 
                                                                 multp(~P1, PRF(x, x.1, x.2)), 
                                                                 H2(~P1,
                                                                    multp(~P1, PRF(x, x.1, x.2)),
                                                                    U(x.3, ~P1), pk(~isk), ~ni), 
                                                                 plus(x.3,
                                                                      multp(H2(~P1,
                                                                               multp(~P1,
                                                                                     PRF(x, x.1,
                                                                                         x.2)),
                                                                               U(x.3, ~P1),
                                                                               pk(~isk), ~ni),
                                                                            PRF(x, x.1, x.2)))
                                                                >,
                                                                ~km)
                                                       ) @ #vk.9 )
                                                  case AS_JOIN_TWO
                                                  solve( !KU( multp(x.5,
                                                                    multp(~isk, multp(x.6, x.7)))
                                                         ) @ #vk.24 )
                                                    case AS_SIGN_TWO_case_2
                                                    solve( !KU( multp(~l.1,
                                                                      plus(multp(~isk,
                                                                                 multp(x, x.1)),
                                                                           multp(multp(x, ~isk),
                                                                                 multp(x.1,
                                                                                       PRF(x.5, x.6,
                                                                                           x.7)))))
                                                           ) @ #vk.26 )
                                                      case AS_SIGN_TWO
                                                      solve( !KU( multp(PRF(x.2, x.3, x.4),
                                                                        H1(~bsn))
                                                             ) @ #vk.32 )
                                                        case AS_SIGN_TWO
                                                        solve( !KU( s(randS1.1,
                                                                      PRF(~DAASeed, ~Ki, ~cnt))
                                                               ) @ #vk.36 )
                                                          case AS_SIGN_TWO
                                                          solve( !KU( H4(H3(multp(~l.1,
                                                                                  multp(x, x.1)),
                                                                            multp(~l.1,
                                                                                  multp(~isk,
                                                                                        multp(x,
                                                                                              x.1))),
                                                                            multp(~l.1,
                                                                                  plus(multp(~isk,
                                                                                             multp(x,
                                                                                                   x.1)),
                                                                                       multp(multp(x,
                                                                                                   ~isk),
                                                                                             multp(x.1,
                                                                                                   PRF(~DAASeed,
                                                                                                       ~Ki,
                                                                                                       ~cnt))))),
                                                                            multp(~l.1,
                                                                                  multp(PRF(~DAASeed,
                                                                                            ~Ki,
                                                                                            ~cnt),
                                                                                        multp(~isk,
                                                                                              multp(x,
                                                                                                    x.1)))),
                                                                            ~nv),
                                                                         ~m.1, H1(~bsn),
                                                                         multp(PRF(~DAASeed, ~Ki,
                                                                                   ~cnt),
                                                                               H1(~bsn)),
                                                                         ~bsn,
                                                                         multp(~randS1, H1(~bsn)),
                                                                         multp(~randS1,
                                                                               multp(~l.1,
                                                                                     multp(~isk,
                                                                                           multp(x,
                                                                                                 x.1)))),
                                                                         nt.1)
                                                                 ) @ #vk.35 )
                                                            case AS_SIGN_TWO
                                                            solve( In_S( $AS, $PS,
                                                                         aenc(<'ISSUER_REQ', ~km, 
                                                                               ~ni>,
                                                                              pk(~sk_ek))
                                                                   ) ▶₀ #k )
                                                              case ChanIn_S_case_2
                                                              solve( In_S( $AS.2, $PS,
                                                                           aenc(<'creI', A, B, C>,
                                                                                pk(~sk_ek))
                                                                     ) ▶₀ #o )
                                                                case ChanIn_S_case_2
                                                                solve( !KU( aenc(<'creI', A, B, C>,
                                                                                 pk(~sk_ek))
                                                                       ) @ #vk.26 )
                                                                  case ISSUER_JOIN_TWO
                                                                  solve( In_S( $PS.1, $AS,
                                                                               <'cre', 
                                                                                multp(x, x.1), 
                                                                                multp(~isk,
                                                                                      multp(x,
                                                                                            x.1)), 
                                                                                plus(multp(~isk,
                                                                                           multp(x,
                                                                                                 x.1)),
                                                                                     multp(multp(x,
                                                                                                 ~isk),
                                                                                           multp(x.1,
                                                                                                 PRF(~DAASeed,
                                                                                                     ~Ki,
                                                                                                     ~cnt)))), 
                                                                                multp(PRF(~DAASeed,
                                                                                          ~Ki,
                                                                                          ~cnt),
                                                                                      multp(~isk,
                                                                                            multp(x,
                                                                                                  x.1)))
                                                                               >
                                                                         ) ▶₀ #p )
                                                                    case ChanIn_S
                                                                    solve( In_S( $AS, $PS,
                                                                                 <~sid, 'PSSign', 
                                                                                  H3(multp(~l.1,
                                                                                           multp(~creRandom,
                                                                                                 ~P1)),
                                                                                     multp(~l.1,
                                                                                           multp(~isk,
                                                                                                 multp(~creRandom,
                                                                                                       ~P1))),
                                                                                     multp(~l.1,
                                                                                           plus(multp(~isk,
                                                                                                      multp(~creRandom,
                                                                                                            ~P1)),
                                                                                                multp(multp(~creRandom,
                                                                                                            ~isk),
                                                                                                      multp(~P1,
                                                                                                            PRF(~DAASeed,
                                                                                                                ~Ki,
                                                                                                                ~cnt))))),
                                                                                     multp(~l.1,
                                                                                           multp(PRF(~DAASeed,
                                                                                                     ~Ki,
                                                                                                     ~cnt),
                                                                                                 multp(~isk,
                                                                                                       multp(~creRandom,
                                                                                                             ~P1)))),
                                                                                     ~nv), 
                                                                                  H1(~bsn), 
                                                                                  multp(~l.1,
                                                                                        multp(~isk,
                                                                                              multp(~creRandom,
                                                                                                    ~P1))), 
                                                                                  ~m.1, ~bsn>
                                                                           ) ▶₀ #s )
                                                                      case ChanIn_S_case_2
                                                                      solve( !KU( ~m.1 ) @ #vk.32 )
                                                                        case VERIFIER_SIGN_ONE
                                                                        solve( !KU( ~nv ) @ #vk.31 )
                                                                          case VERIFIER_SIGN_ONE
                                                                          solve( !KU( ~nt
                                                                                 ) @ #vk.37 )
                                                                            case AS_SIGN_TWO
                                                                            solve( !KU( aenc(<
                                                                                              'ISSUER_REQ', 
                                                                                              ~km, 
                                                                                              ~ni>,
                                                                                             pk(~sk_ek))
                                                                                   ) @ #vk.28 )
                                                                              case ISSUER_JOIN_ONE
                                                                              solve( !KU( multp(~P1,
                                                                                                PRF(~DAASeed,
                                                                                                    ~Ki,
                                                                                                    ~cnt))
                                                                                     ) @ #vk.30 )
                                                                                case AS_JOIN_TWO
                                                                                solve( !KU( H2(~P1,
                                                                                               multp(~P1,
                                                                                                     PRF(~DAASeed,
                                                                                                         ~Ki,
                                                                                                         ~cnt)),
                                                                                               U(~u,
                                                                                                 ~P1),
                                                                                               pk(~isk),
                                                                                               ~ni)
                                                                                       ) @ #vk.31 )
                                                                                  case AS_JOIN_TWO
                                                                                  solve( !KU( plus(~u,
                                                                                                   multp(H2(~P1,
                                                                                                            multp(~P1,
                                                                                                                  PRF(~DAASeed,
                                                                                                                      ~Ki,
                                                                                                                      ~cnt)),
                                                                                                            U(~u,
                                                                                                              ~P1),
                                                                                                            pk(~isk),
                                                                                                            ~ni),
                                                                                                         PRF(~DAASeed,
                                                                                                             ~Ki,
                                                                                                             ~cnt)))
                                                                                         ) @ #vk.32 )
                                                                                    case AS_JOIN_TWO
                                                                                    solve( !KU( multp(~l.1,
                                                                                                      multp(~creRandom,
                                                                                                            ~P1))
                                                                                           ) @ #vk.35 )
                                                                                      case AS_SIGN_TWO
                                                                                      solve( !KU( multp(~l.1,
                                                                                                        multp(PRF(~DAASeed,
                                                                                                                  ~Ki,
                                                                                                                  ~cnt),
                                                                                                              multp(~isk,
                                                                                                                    multp(~creRandom,
                                                                                                                          ~P1))))
                                                                                             ) @ #vk.36 )
                                                                                        case AS_SIGN_TWO
                                                                                        solve( !KU( H1(~bsn)
                                                                                               ) @ #vk.37 )
                                                                                          case AS_SIGN_TWO
                                                                                          SOLVED // trace found
                                                                                        qed
                                                                                      qed
                                                                                    qed
                                                                                  qed
                                                                                qed
                                                                              qed
                                                                            qed
                                                                          qed
                                                                        qed
                                                                      qed
                                                                    qed
                                                                  qed
                                                                qed
                                                              qed
                                                            qed
                                                          qed
                                                        qed
                                                      qed
                                                    qed
                                                  qed
                                                qed
                                              qed
                                            qed
                                          qed
                                        qed
                                      qed
                                    qed
                                  qed
                                qed
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma functional_correctness_dishonest_send:
  exists-trace
  "∃ V nv #j.
    (Confirm( V, nv ) @ #j) ∧ (¬(∃ #i. Send( V, nv ) @ #i))"
/*
guarded formula characterizing all satisfying traces:
"∃ V nv #j.
  (Confirm( V, nv ) @ #j) ∧ ∀ #i. (Send( V, nv ) @ #i) ⇒ ⊥"
*/
simplify
solve( Confirm( V, nv ) @ #j )
  case VERIFIER_VERIFY_ONE_NO_STATE
  solve( !F_BSN( $I, bsn ) ▶₁ #j )
    case ISSUER_SETUP
    solve( !F_IssuerPK( $I, pk(x.3) ) ▶₂ #j )
      case ISSUER_SETUP
      solve( !KU( multp(x, multp(~isk, multp(x.1, x.2))) ) @ #vk.8 )
        case AS_SIGN_TWO_case_2
        solve( !KU( multp(~l,
                          plus(multp(~isk, multp(x, x.1)),
                               multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4)))))
               ) @ #vk.10 )
          case AS_SIGN_TWO
          solve( !KU( multp(PRF(x.2, x.3, x.4), H1(~bsn)) ) @ #vk.16 )
            case c_multp
            solve( !KU( H4(H3(multp(~l, multp(x, x.1)),
                              multp(~l, multp(~isk, multp(x, x.1))),
                              multp(~l,
                                    plus(multp(~isk, multp(x, x.1)),
                                         multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4))))),
                              multp(~l, multp(PRF(x.2, x.3, x.4), multp(~isk, multp(x, x.1)))),
                              nv),
                           m, H1(~bsn), multp(PRF(x.2, x.3, x.4), H1(~bsn)), ~bsn,
                           multp(randS1, H1(~bsn)),
                           multp(randS1, multp(~l, multp(~isk, multp(x, x.1)))), nt)
                   ) @ #vk.18 )
              case AS_SIGN_TWO
              solve( !KU( PRF(~DAASeed, ~Ki, ~cnt) ) @ #vk.30 )
                case REVEAL_TSK
                solve( In_S( $PS.1, $AS,
                             <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                              plus(multp(~isk, multp(x, x.1)),
                                   multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt)))), 
                              multp(PRF(~DAASeed, ~Ki, ~cnt), multp(~isk, multp(x, x.1)))>
                       ) ▶₀ #vr.10 )
                  case ChanIn_S
                  solve( In_S( $AS, $PS,
                               <~sid, 'PSSign', H3(R, S, T, W, nv.1), H1(bsn.1), S, m.2, bsn.1>
                         ) ▶₀ #vr.11 )
                    case ChanIn_S_case_2
                    solve( In_S( $AS.1, $PS, aenc(<'ISSUER_REQ', km, ni>, pk(~sk_ek))
                           ) ▶₀ #vr.13 )
                      case ChanIn_S_case_2
                      solve( !KU( aenc(<'ISSUER_REQ', km, ni>, pk(~sk_ek)) ) @ #vk.34 )
                        case ISSUER_JOIN_ONE
                        solve( In_S( $PS.1, $AS,
                                     <'cre', multp(x.2, x.3), multp(~isk, multp(x.2, x.3)), 
                                      plus(multp(~isk, multp(x.2, x.3)),
                                           multp(multp(x.2, ~isk),
                                                 multp(x.3, PRF(x.4, x.5, x.6)))), 
                                      multp(PRF(x.4, x.5, x.6), multp(~isk, multp(x.2, x.3)))>
                               ) ▶₀ #vr.30 )
                          case ChanIn_S
                          solve( In_S( $AS, $PS,
                                       <~sid.1, 'PSSign', 
                                        H3(multp(~l, multp(x, x.1)),
                                           multp(~l, multp(~isk, multp(x, x.1))),
                                           multp(~l,
                                                 plus(multp(~isk, multp(x, x.1)),
                                                      multp(multp(x, ~isk),
                                                            multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))),
                                           multp(~l,
                                                 multp(PRF(~DAASeed, ~Ki, ~cnt),
                                                       multp(~isk, multp(x, x.1)))),
                                           nv), 
                                        H1(~bsn), multp(~l, multp(~isk, multp(x, x.1))), m, ~bsn>
                                 ) ▶₀ #vr.31 )
                            case ChanIn_S
                            solve( In_S( $AS, $PS,
                                         aenc(<'creI', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                                               plus(multp(~isk, multp(x, x.1)),
                                                    multp(multp(x, ~isk),
                                                          multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                                              >,
                                              pk(~sk_ek))
                                   ) ▶₀ #vr.25 )
                              case ChanIn_S_case_2
                              solve( !KU( aenc(<'creI', multp(x, x.1), 
                                                multp(~isk, multp(x, x.1)), 
                                                plus(multp(~isk, multp(x, x.1)),
                                                     multp(multp(x, ~isk),
                                                           multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                                               >,
                                               pk(~sk_ek))
                                     ) @ #vk.29 )
                                case ISSUER_JOIN_TWO
                                solve( !KU( multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)) ) @ #vk.33 )
                                  case AS_JOIN_TWO
                                  solve( !KU( H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                                                 U(x, ~P1), pk(~isk), ~ni)
                                         ) @ #vk.35 )
                                    case AS_JOIN_TWO
                                    solve( !KU( ~nt ) @ #vk.32 )
                                      case AS_SIGN_TWO
                                      solve( !KU( s(~randS1, PRF(~DAASeed, ~Ki, ~cnt)) ) @ #vk.31 )
                                        case AS_SIGN_TWO
                                        solve( !KU( multp(~l, multp(~creRandom, ~P1)) ) @ #vk.29 )
                                          case AS_SIGN_TWO
                                          solve( !KU( multp(~l,
                                                            multp(PRF(~DAASeed, ~Ki, ~cnt),
                                                                  multp(~isk,
                                                                        multp(~creRandom, ~P1))))
                                                 ) @ #vk.31 )
                                            case AS_SIGN_TWO
                                            solve( !KU( H1(~bsn) ) @ #vk.32 )
                                              case c_H1
                                              solve( !KU( ~bsn ) @ #vk.39 )
                                                case ISSUER_SETUP
                                                solve( !KU( plus(~u,
                                                                 multp(H2(~P1,
                                                                          multp(~P1,
                                                                                PRF(~DAASeed, ~Ki,
                                                                                    ~cnt)),
                                                                          U(~u, ~P1), pk(~isk),
                                                                          ~ni),
                                                                       PRF(~DAASeed, ~Ki, ~cnt)))
                                                       ) @ #vk.38 )
                                                  case AS_JOIN_TWO
                                                  solve( !KU( MAC(<'gamma', ~P1, 
                                                                   multp(~P1,
                                                                         PRF(~DAASeed, ~Ki, ~cnt)), 
                                                                   H2(~P1,
                                                                      multp(~P1,
                                                                            PRF(~DAASeed, ~Ki,
                                                                                ~cnt)),
                                                                      U(~u, ~P1), pk(~isk), ~ni), 
                                                                   plus(~u,
                                                                        multp(H2(~P1,
                                                                                 multp(~P1,
                                                                                       PRF(~DAASeed,
                                                                                           ~Ki,
                                                                                           ~cnt)),
                                                                                 U(~u, ~P1),
                                                                                 pk(~isk), ~ni),
                                                                              PRF(~DAASeed, ~Ki,
                                                                                  ~cnt)))
                                                                  >,
                                                                  ~km)
                                                         ) @ #vk.39 )
                                                    case AS_JOIN_TWO
                                                    SOLVED // trace found
                                                  qed
                                                qed
                                              qed
                                            qed
                                          qed
                                        qed
                                      qed
                                    qed
                                  qed
                                qed
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma functional_correctness_group_verification:
  exists-trace
  "∃ V V1 nv #i #j.
    ((Send( V, nv ) @ #i) ∧ (Confirm( V1, nv ) @ #j)) ∧ (¬(V = V1))"
/*
guarded formula characterizing all satisfying traces:
"∃ V V1 nv #i #j.
  (Send( V, nv ) @ #i) ∧ (Confirm( V1, nv ) @ #j) ∧ ¬(V = V1)"
*/
simplify
solve( Confirm( V1, ~nv ) @ #j )
  case VERIFIER_VERIFY_ONE_NO_STATE
  solve( !F_BSN( $I, bsn ) ▶₁ #j )
    case ISSUER_SETUP
    solve( !F_IssuerPK( $I, pk(x.3) ) ▶₂ #j )
      case ISSUER_SETUP
      solve( !KU( multp(x, multp(~isk, multp(x.1, x.2))) ) @ #vk.8 )
        case AS_SIGN_TWO_case_2
        solve( !KU( multp(~l,
                          plus(multp(~isk, multp(x, x.1)),
                               multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4)))))
               ) @ #vk.10 )
          case AS_SIGN_TWO
          solve( !KU( multp(PRF(x.2, x.3, x.4), H1(~bsn)) ) @ #vk.16 )
            case c_multp
            solve( !KU( H4(H3(multp(~l, multp(x, x.1)),
                              multp(~l, multp(~isk, multp(x, x.1))),
                              multp(~l,
                                    plus(multp(~isk, multp(x, x.1)),
                                         multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4))))),
                              multp(~l, multp(PRF(x.2, x.3, x.4), multp(~isk, multp(x, x.1)))),
                              ~nv),
                           m.1, H1(~bsn), multp(PRF(x.2, x.3, x.4), H1(~bsn)), ~bsn,
                           multp(randS1, H1(~bsn)),
                           multp(randS1, multp(~l, multp(~isk, multp(x, x.1)))), nt)
                   ) @ #vk.18 )
              case AS_SIGN_TWO
              solve( !KU( PRF(~DAASeed, ~Ki, ~cnt) ) @ #vk.30 )
                case REVEAL_TSK
                solve( In_S( $PS.1, $AS,
                             <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                              plus(multp(~isk, multp(x, x.1)),
                                   multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt)))), 
                              multp(PRF(~DAASeed, ~Ki, ~cnt), multp(~isk, multp(x, x.1)))>
                       ) ▶₀ #vr.10 )
                  case ChanIn_S
                  solve( In_S( $AS, $PS,
                               <~sid, 'PSSign', H3(R, S, T, W, nv.1), H1(bsn.1), S, m.3, bsn.1>
                         ) ▶₀ #vr.11 )
                    case ChanIn_S_case_2
                    solve( In_S( $AS.1, $PS, aenc(<'ISSUER_REQ', km, ni>, pk(~sk_ek))
                           ) ▶₀ #vr.13 )
                      case ChanIn_S_case_2
                      solve( !KU( aenc(<'ISSUER_REQ', km, ni>, pk(~sk_ek)) ) @ #vk.34 )
                        case ISSUER_JOIN_ONE
                        solve( In_S( $PS.1, $AS,
                                     <'cre', multp(x.2, x.3), multp(~isk, multp(x.2, x.3)), 
                                      plus(multp(~isk, multp(x.2, x.3)),
                                           multp(multp(x.2, ~isk),
                                                 multp(x.3, PRF(x.4, x.5, x.6)))), 
                                      multp(PRF(x.4, x.5, x.6), multp(~isk, multp(x.2, x.3)))>
                               ) ▶₀ #vr.30 )
                          case ChanIn_S
                          solve( In_S( $AS, $PS,
                                       <~sid.1, 'PSSign', 
                                        H3(multp(~l, multp(x, x.1)),
                                           multp(~l, multp(~isk, multp(x, x.1))),
                                           multp(~l,
                                                 plus(multp(~isk, multp(x, x.1)),
                                                      multp(multp(x, ~isk),
                                                            multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))),
                                           multp(~l,
                                                 multp(PRF(~DAASeed, ~Ki, ~cnt),
                                                       multp(~isk, multp(x, x.1)))),
                                           ~nv), 
                                        H1(~bsn), multp(~l, multp(~isk, multp(x, x.1))), m.1, ~bsn>
                                 ) ▶₀ #vr.31 )
                            case ChanIn_S
                            solve( In_S( $AS, $PS,
                                         aenc(<'creI', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                                               plus(multp(~isk, multp(x, x.1)),
                                                    multp(multp(x, ~isk),
                                                          multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                                              >,
                                              pk(~sk_ek))
                                   ) ▶₀ #vr.25 )
                              case ChanIn_S_case_2
                              solve( !KU( aenc(<'creI', multp(x, x.1), 
                                                multp(~isk, multp(x, x.1)), 
                                                plus(multp(~isk, multp(x, x.1)),
                                                     multp(multp(x, ~isk),
                                                           multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                                               >,
                                               pk(~sk_ek))
                                     ) @ #vk.29 )
                                case ISSUER_JOIN_TWO
                                solve( !KU( multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)) ) @ #vk.33 )
                                  case AS_JOIN_TWO
                                  solve( !KU( H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                                                 U(x, ~P1), pk(~isk), ~ni)
                                         ) @ #vk.35 )
                                    case AS_JOIN_TWO
                                    solve( !KU( ~nv ) @ #vk.31 )
                                      case VERIFIER_SIGN_ONE
                                      solve( !KU( ~nt ) @ #vk.33 )
                                        case AS_SIGN_TWO
                                        solve( !KU( s(~randS1, PRF(~DAASeed, ~Ki, ~cnt))
                                               ) @ #vk.33 )
                                          case AS_SIGN_TWO
                                          solve( !KU( multp(~l, multp(~creRandom, ~P1)) ) @ #vk.31 )
                                            case AS_SIGN_TWO
                                            solve( !KU( multp(~l,
                                                              multp(PRF(~DAASeed, ~Ki, ~cnt),
                                                                    multp(~isk,
                                                                          multp(~creRandom, ~P1))))
                                                   ) @ #vk.32 )
                                              case AS_SIGN_TWO
                                              solve( !KU( H1(~bsn) ) @ #vk.33 )
                                                case c_H1
                                                solve( !KU( ~bsn ) @ #vk.39 )
                                                  case ISSUER_SETUP
                                                  solve( !KU( plus(~u,
                                                                   multp(H2(~P1,
                                                                            multp(~P1,
                                                                                  PRF(~DAASeed, ~Ki,
                                                                                      ~cnt)),
                                                                            U(~u, ~P1), pk(~isk),
                                                                            ~ni),
                                                                         PRF(~DAASeed, ~Ki, ~cnt)))
                                                         ) @ #vk.38 )
                                                    case AS_JOIN_TWO
                                                    solve( !KU( MAC(<'gamma', ~P1, 
                                                                     multp(~P1,
                                                                           PRF(~DAASeed, ~Ki,
                                                                               ~cnt)), 
                                                                     H2(~P1,
                                                                        multp(~P1,
                                                                              PRF(~DAASeed, ~Ki,
                                                                                  ~cnt)),
                                                                        U(~u, ~P1), pk(~isk), ~ni), 
                                                                     plus(~u,
                                                                          multp(H2(~P1,
                                                                                   multp(~P1,
                                                                                         PRF(~DAASeed,
                                                                                             ~Ki,
                                                                                             ~cnt)),
                                                                                   U(~u, ~P1),
                                                                                   pk(~isk), ~ni),
                                                                                PRF(~DAASeed, ~Ki,
                                                                                    ~cnt)))
                                                                    >,
                                                                    ~km)
                                                           ) @ #vk.39 )
                                                      case AS_JOIN_TWO
                                                      SOLVED // trace found
                                                    qed
                                                  qed
                                                qed
                                              qed
                                            qed
                                          qed
                                        qed
                                      qed
                                    qed
                                  qed
                                qed
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma aliveness:
  all-traces
  "∀ a b n #i.
    (Commit( a, b, n ) @ #i) ⇒
    ((((∃ #j. Create( a ) @ #j) ∨
       (∃ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
      (∃ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
     (∃ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i)))"
/*
guarded formula characterizing all counter-examples:
"∃ a b n #i.
  (Commit( a, b, n ) @ #i)
 ∧
  (∀ #j. (Create( a ) @ #j) ⇒ ⊥) ∧
  (∀ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥)"
*/
simplify
solve( !F_IssuerPK( $I, pk(x.2) ) ▶₁ #i )
  case ISSUER_SETUP
  solve( In_S( $PS, $AS,
               <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                plus(multp(~isk, multp(x, x.1)),
                     multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4)))), 
                multp(PRF(x.2, x.3, x.4), multp(~isk, multp(x, x.1)))>
         ) ▶₀ #i )
    case ChanIn_S
    solve( In_S( $AS, $PS,
                 aenc(<'creI', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                       plus(multp(~isk, multp(x, x.1)),
                            multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                      >,
                      pk(~sk_ek))
           ) ▶₀ #vr.3 )
      case ChanIn_S_case_1
      by contradiction /* from formulas */
    next
      case ChanIn_S_case_2
      solve( !KU( aenc(<'creI', multp(x, x.1), 
                        multp(~isk, multp(x, x.1)), 
                        plus(multp(~isk, multp(x, x.1)),
                             multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                       >,
                       pk(~sk_ek))
             ) @ #vk )
        case ISSUER_JOIN_TWO
        by contradiction /* from formulas */
      next
        case c_aenc
        solve( !KU( multp(~isk, multp(x, x.1)) ) @ #vk.7 )
          case ISSUER_JOIN_TWO
          by contradiction /* from formulas */
        next
          case c_multp
          solve( !KU( ~isk ) @ #vk.9 )
            case ISSUER_KEY_REVEAL
            by contradiction /* from formulas */
          qed
        qed
      qed
    qed
  qed
qed

lemma weak_agreement_any_reveal:
  all-traces
  "∀ a b n #i.
    (Commit( a, b, n ) @ #i) ⇒
    ((((∃ n2 #j. Running( b, a, n2 ) @ #j) ∨
       (∃ C #r. IssuerKeyReveal( C ) @ #r)) ∨
      (∃ C #r. RevealEK( C ) @ #r)) ∨
     (∃ C #r. RevealTsk( C ) @ #r))"
/*
guarded formula characterizing all counter-examples:
"∃ a b n #i.
  (Commit( a, b, n ) @ #i)
 ∧
  (∀ n2 #j. (Running( b, a, n2 ) @ #j) ⇒ ⊥) ∧
  (∀ C #r. (IssuerKeyReveal( C ) @ #r) ⇒ ⊥) ∧
  (∀ C #r. (RevealEK( C ) @ #r) ⇒ ⊥) ∧
  (∀ C #r. (RevealTsk( C ) @ #r) ⇒ ⊥)"
*/
simplify
solve( !F_IssuerPK( $I, pk(x.2) ) ▶₁ #i )
  case ISSUER_SETUP
  solve( In_S( $PS, $AS,
               <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                plus(multp(~isk, multp(x, x.1)),
                     multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4)))), 
                multp(PRF(x.2, x.3, x.4), multp(~isk, multp(x, x.1)))>
         ) ▶₀ #i )
    case ChanIn_S
    solve( In_S( $AS, $PS,
                 aenc(<'creI', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                       plus(multp(~isk, multp(x, x.1)),
                            multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                      >,
                      pk(~sk_ek))
           ) ▶₀ #vr.3 )
      case ChanIn_S_case_1
      by contradiction /* from formulas */
    next
      case ChanIn_S_case_2
      solve( !KU( aenc(<'creI', multp(x, x.1), 
                        multp(~isk, multp(x, x.1)), 
                        plus(multp(~isk, multp(x, x.1)),
                             multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                       >,
                       pk(~sk_ek))
             ) @ #vk )
        case ISSUER_JOIN_TWO
        by contradiction /* from formulas */
      next
        case c_aenc
        solve( !KU( multp(~isk, multp(x, x.1)) ) @ #vk.7 )
          case ISSUER_JOIN_TWO
          solve( !KU( ~sk_ek.1 ) @ #vk.18 )
            case PLATFORM_CORRUPT
            by contradiction /* from formulas */
          qed
        next
          case c_multp
          solve( !KU( ~isk ) @ #vk.9 )
            case ISSUER_KEY_REVEAL
            by contradiction /* from formulas */
          qed
        qed
      qed
    qed
  qed
qed

lemma weak_agreement:
  all-traces
  "∀ a b n #i.
    (Commit( a, b, n ) @ #i) ⇒
    ((((∃ n2 #j. Running( b, a, n2 ) @ #j) ∨
       (∃ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
      (∃ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
     (∃ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i)))"
/*
guarded formula characterizing all counter-examples:
"∃ a b n #i.
  (Commit( a, b, n ) @ #i)
 ∧
  (∀ n2 #j. (Running( b, a, n2 ) @ #j) ⇒ ⊥) ∧
  (∀ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥)"
*/
simplify
solve( !F_IssuerPK( $I, pk(x.2) ) ▶₁ #i )
  case ISSUER_SETUP
  solve( In_S( $PS, $AS,
               <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                plus(multp(~isk, multp(x, x.1)),
                     multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4)))), 
                multp(PRF(x.2, x.3, x.4), multp(~isk, multp(x, x.1)))>
         ) ▶₀ #i )
    case ChanIn_S
    solve( In_S( $AS, $PS,
                 aenc(<'creI', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                       plus(multp(~isk, multp(x, x.1)),
                            multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                      >,
                      pk(~sk_ek))
           ) ▶₀ #vr.3 )
      case ChanIn_S_case_2
      solve( !KU( aenc(<'creI', multp(x, x.1), 
                        multp(~isk, multp(x, x.1)), 
                        plus(multp(~isk, multp(x, x.1)),
                             multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                       >,
                       pk(~sk_ek))
             ) @ #vk )
        case c_aenc
        solve( !KU( multp(~isk, multp(x, x.1)) ) @ #vk.7 )
          case ISSUER_JOIN_TWO
          solve( !KU( ~sk_ek.1 ) @ #vk.18 )
            case PLATFORM_CORRUPT
            solve( !KU( plus(multp(~isk, multp(~creRandom, ~P1)),
                             multp(multp(~creRandom, ~isk),
                                   multp(~P1, PRF(~DAASeed, ~Ki, ~cnt))))
                   ) @ #vk.9 )
              case ISSUER_JOIN_TWO
              solve( !KU( multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)) ) @ #vk.13 )
                case AS_JOIN_TWO
                solve( !KU( H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                               U(x, ~P1), pk(~isk), ~ni.1)
                       ) @ #vk.15 )
                  case AS_JOIN_TWO
                  solve( !KU( MAC(<'gamma', ~P1, 
                                   multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), 
                                   H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), U(~u, ~P1),
                                      pk(~isk), ~ni), 
                                   plus(~u,
                                        multp(H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                                                 U(~u, ~P1), pk(~isk), ~ni),
                                              PRF(~DAASeed, ~Ki, ~cnt)))
                                  >,
                                  ~km.1)
                         ) @ #vk.18 )
                    case AS_JOIN_TWO
                    solve( In_S( $AS, $PS, aenc(<'ISSUER_REQ', ~km, ~ni>, pk(~sk_ek))
                           ) ▶₀ #vr.5 )
                      case ChanIn_S_case_2
                      solve( !KU( aenc(<'ISSUER_REQ', ~km, ~ni>, pk(~sk_ek)) ) @ #vk.19 )
                        case c_aenc
                        solve( !KU( ~km ) @ #vk.23 )
                          case ISSUER_JOIN_ONE
                          solve( !KU( ~ni ) @ #vk.24 )
                            case ISSUER_JOIN_ONE
                            solve( !KU( pk(~sk_ek) ) @ #vk.18 )
                              case PLATFORM_SETUP
                              solve( !KU( multp(~creRandom, ~P1) ) @ #vk.21 )
                                case ISSUER_JOIN_TWO
                                solve( !KU( plus(~u,
                                                 multp(H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                                                          U(~u, ~P1), pk(~isk), ~ni),
                                                       PRF(~DAASeed, ~Ki, ~cnt)))
                                       ) @ #vk.23 )
                                  case AS_JOIN_TWO
                                  SOLVED // trace found
                                qed
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma ni_agreement_any_reveal:
  all-traces
  "∀ a b n #i.
    (Commit( a, b, n ) @ #i) ⇒
    ((((∃ #j. Running( b, a, n ) @ #j) ∨
       (∃ C #r. IssuerKeyReveal( C ) @ #r)) ∨
      (∃ C #r. RevealEK( C ) @ #r)) ∨
     (∃ C #r. RevealTsk( C ) @ #r))"
/*
guarded formula characterizing all counter-examples:
"∃ a b n #i.
  (Commit( a, b, n ) @ #i)
 ∧
  (∀ #j. (Running( b, a, n ) @ #j) ⇒ ⊥) ∧
  (∀ C #r. (IssuerKeyReveal( C ) @ #r) ⇒ ⊥) ∧
  (∀ C #r. (RevealEK( C ) @ #r) ⇒ ⊥) ∧
  (∀ C #r. (RevealTsk( C ) @ #r) ⇒ ⊥)"
*/
simplify
solve( !F_IssuerPK( $I, pk(x.2) ) ▶₁ #i )
  case ISSUER_SETUP
  solve( In_S( $PS, $AS,
               <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                plus(multp(~isk, multp(x, x.1)),
                     multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4)))), 
                multp(PRF(x.2, x.3, x.4), multp(~isk, multp(x, x.1)))>
         ) ▶₀ #i )
    case ChanIn_S
    solve( In_S( $AS, $PS,
                 aenc(<'creI', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                       plus(multp(~isk, multp(x, x.1)),
                            multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                      >,
                      pk(~sk_ek))
           ) ▶₀ #vr.3 )
      case ChanIn_S_case_1
      by contradiction /* from formulas */
    next
      case ChanIn_S_case_2
      solve( !KU( aenc(<'creI', multp(x, x.1), 
                        multp(~isk, multp(x, x.1)), 
                        plus(multp(~isk, multp(x, x.1)),
                             multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                       >,
                       pk(~sk_ek))
             ) @ #vk )
        case ISSUER_JOIN_TWO
        by contradiction /* from formulas */
      next
        case c_aenc
        solve( !KU( multp(~isk, multp(x, x.1)) ) @ #vk.7 )
          case ISSUER_JOIN_TWO
          solve( !KU( ~sk_ek.1 ) @ #vk.18 )
            case PLATFORM_CORRUPT
            by contradiction /* from formulas */
          qed
        next
          case c_multp
          solve( !KU( ~isk ) @ #vk.9 )
            case ISSUER_KEY_REVEAL
            by contradiction /* from formulas */
          qed
        qed
      qed
    qed
  qed
qed

lemma ni_agreement:
  all-traces
  "∀ a b n #i.
    (Commit( a, b, n ) @ #i) ⇒
    ((((∃ #j. Running( b, a, n ) @ #j) ∨
       (∃ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
      (∃ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
     (∃ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i)))"
/*
guarded formula characterizing all counter-examples:
"∃ a b n #i.
  (Commit( a, b, n ) @ #i)
 ∧
  (∀ #j. (Running( b, a, n ) @ #j) ⇒ ⊥) ∧
  (∀ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥)"
*/
simplify
solve( !F_IssuerPK( $I, pk(x.2) ) ▶₁ #i )
  case ISSUER_SETUP
  solve( In_S( $PS, $AS,
               <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                plus(multp(~isk, multp(x, x.1)),
                     multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4)))), 
                multp(PRF(x.2, x.3, x.4), multp(~isk, multp(x, x.1)))>
         ) ▶₀ #i )
    case ChanIn_S
    solve( In_S( $AS, $PS,
                 aenc(<'creI', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                       plus(multp(~isk, multp(x, x.1)),
                            multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                      >,
                      pk(~sk_ek))
           ) ▶₀ #vr.3 )
      case ChanIn_S_case_2
      solve( !KU( aenc(<'creI', multp(x, x.1), 
                        multp(~isk, multp(x, x.1)), 
                        plus(multp(~isk, multp(x, x.1)),
                             multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                       >,
                       pk(~sk_ek))
             ) @ #vk )
        case c_aenc
        solve( !KU( multp(~isk, multp(x, x.1)) ) @ #vk.7 )
          case ISSUER_JOIN_TWO
          solve( !KU( ~sk_ek.1 ) @ #vk.18 )
            case PLATFORM_CORRUPT
            solve( !KU( plus(multp(~isk, multp(~creRandom, ~P1)),
                             multp(multp(~creRandom, ~isk),
                                   multp(~P1, PRF(~DAASeed, ~Ki, ~cnt))))
                   ) @ #vk.9 )
              case ISSUER_JOIN_TWO
              solve( !KU( multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)) ) @ #vk.13 )
                case AS_JOIN_TWO
                solve( !KU( H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                               U(x, ~P1), pk(~isk), ~ni.1)
                       ) @ #vk.15 )
                  case AS_JOIN_TWO
                  solve( !KU( MAC(<'gamma', ~P1, 
                                   multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), 
                                   H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), U(~u, ~P1),
                                      pk(~isk), ~ni), 
                                   plus(~u,
                                        multp(H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                                                 U(~u, ~P1), pk(~isk), ~ni),
                                              PRF(~DAASeed, ~Ki, ~cnt)))
                                  >,
                                  ~km.1)
                         ) @ #vk.18 )
                    case AS_JOIN_TWO
                    solve( In_S( $AS, $PS, aenc(<'ISSUER_REQ', ~km, ~ni>, pk(~sk_ek))
                           ) ▶₀ #vr.5 )
                      case ChanIn_S_case_2
                      solve( !KU( aenc(<'ISSUER_REQ', ~km, ~ni>, pk(~sk_ek)) ) @ #vk.19 )
                        case c_aenc
                        solve( !KU( ~km ) @ #vk.23 )
                          case ISSUER_JOIN_ONE
                          solve( !KU( ~ni ) @ #vk.24 )
                            case ISSUER_JOIN_ONE
                            solve( !KU( pk(~sk_ek) ) @ #vk.18 )
                              case PLATFORM_SETUP
                              solve( !KU( multp(~creRandom, ~P1) ) @ #vk.21 )
                                case ISSUER_JOIN_TWO
                                solve( !KU( plus(~u,
                                                 multp(H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                                                          U(~u, ~P1), pk(~isk), ~ni),
                                                       PRF(~DAASeed, ~Ki, ~cnt)))
                                       ) @ #vk.23 )
                                  case AS_JOIN_TWO
                                  SOLVED // trace found
                                qed
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma i_agreement:
  all-traces
  "∀ a b n #i.
    (Commit( a, b, n ) @ #i) ⇒
    ((((∃ #j.
         ((Running( a, b, n ) @ #j) ∧ (#j < #i)) ∧
         (¬(∃ a2 b2 #i2. (Commit( a2, b2, n ) @ #i2) ∧ (¬(#i2 = #i))))) ∨
       (∃ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
      (∃ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
     (∃ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i)))"
/*
guarded formula characterizing all counter-examples:
"∃ a b n #i.
  (Commit( a, b, n ) @ #i)
 ∧
  (∀ #j.
    (Running( a, b, n ) @ #j)
   ⇒
    ((¬(#j < #i)) ∨
     (∃ a2 b2 #i2. (Commit( a2, b2, n ) @ #i2) ∧ ¬(#i2 = #i)))) ∧
  (∀ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥)"
*/
simplify
solve( !F_IssuerPK( $I, pk(x.2) ) ▶₁ #i )
  case ISSUER_SETUP
  solve( In_S( $PS, $AS,
               <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                plus(multp(~isk, multp(x, x.1)),
                     multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4)))), 
                multp(PRF(x.2, x.3, x.4), multp(~isk, multp(x, x.1)))>
         ) ▶₀ #i )
    case ChanIn_S
    solve( In_S( $AS, $PS,
                 aenc(<'creI', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                       plus(multp(~isk, multp(x, x.1)),
                            multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                      >,
                      pk(~sk_ek))
           ) ▶₀ #vr.3 )
      case ChanIn_S_case_2
      solve( !KU( aenc(<'creI', multp(x, x.1), 
                        multp(~isk, multp(x, x.1)), 
                        plus(multp(~isk, multp(x, x.1)),
                             multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                       >,
                       pk(~sk_ek))
             ) @ #vk )
        case ISSUER_JOIN_TWO
        solve( !KU( multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)) ) @ #vk.4 )
          case AS_JOIN_TWO
          solve( !KU( H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                         U(x, ~P1), pk(~isk), ~ni.1)
                 ) @ #vk.6 )
            case AS_JOIN_TWO
            solve( !KU( MAC(<'gamma', ~P1, 
                             multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), 
                             H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), U(~u, ~P1), pk(~isk),
                                ~ni), 
                             plus(~u,
                                  multp(H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), U(~u, ~P1),
                                           pk(~isk), ~ni),
                                        PRF(~DAASeed, ~Ki, ~cnt)))
                            >,
                            ~km.1)
                   ) @ #vk.9 )
              case AS_JOIN_TWO
              solve( In_S( $AS, $PS, aenc(<'ISSUER_REQ', ~km, ~ni>, pk(~sk_ek))
                     ) ▶₀ #vr.5 )
                case ChanIn_S_case_2
                solve( !KU( plus(~u,
                                 multp(H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), U(~u, ~P1),
                                          pk(~isk), ~ni),
                                       PRF(~DAASeed, ~Ki, ~cnt)))
                       ) @ #vk.9 )
                  case AS_JOIN_TWO
                  solve( !KU( aenc(<'ISSUER_REQ', ~km, ~ni>, pk(~sk_ek)) ) @ #vk.10 )
                    case ISSUER_JOIN_ONE
                    SOLVED // trace found
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma secrecy_cre:
  all-traces
  "∀ A B x #i.
    (Secret( A, B, x ) @ #i) ⇒
    ((((¬(∃ #k. K( x ) @ #k)) ∨
       (∃ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
      (∃ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i))) ∨
     (∃ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i)))"
/*
guarded formula characterizing all counter-examples:
"∃ A B x #i.
  (Secret( A, B, x ) @ #i)
 ∧
  (∃ #k. (K( x ) @ #k)) ∧
  (∀ C #r. (IssuerKeyReveal( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealEK( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥) ∧
  (∀ C #r. (RevealTsk( C ) @ #r) ∧ (Honest( C ) @ #i) ⇒ ⊥)"
*/
simplify
solve( !F_IssuerPK( $I, pk(x.2) ) ▶₁ #i )
  case ISSUER_SETUP
  solve( !KU( multp(~isk, multp(x, x.1)) ) @ #vk.3 )
    case ISSUER_JOIN_TWO
    solve( !KU( ~sk_ek ) @ #vk.14 )
      case PLATFORM_CORRUPT
      solve( !KU( plus(multp(~isk, multp(~creRandom, ~P1)),
                       multp(multp(~creRandom, ~isk), multp(~P1, PRF(x, x.1, x.2))))
             ) @ #vk.5 )
        case ISSUER_JOIN_TWO
        solve( !KU( multp(~P1, PRF(x, x.1, x.2)) ) @ #vk.9 )
          case AS_JOIN_TWO
          solve( !KU( H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                         U(x, ~P1), pk(~isk), ~ni)
                 ) @ #vk.11 )
            case AS_JOIN_TWO
            solve( !KU( MAC(<'gamma', ~P1, 
                             multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), 
                             H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), U(~u, ~P1), pk(~isk),
                                ~ni), 
                             plus(~u,
                                  multp(H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)), U(~u, ~P1),
                                           pk(~isk), ~ni),
                                        PRF(~DAASeed, ~Ki, ~cnt)))
                            >,
                            ~km)
                   ) @ #vk.14 )
              case AS_JOIN_TWO
              solve( In_S( $PS, $AS,
                           <'cre', multp(~creRandom, ~P1), 
                            multp(~isk, multp(~creRandom, ~P1)), 
                            plus(multp(~isk, multp(~creRandom, ~P1)),
                                 multp(multp(~creRandom, ~isk),
                                       multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)))), 
                            multp(PRF(~DAASeed, ~Ki, ~cnt),
                                  multp(~isk, multp(~creRandom, ~P1)))
                           >
                     ) ▶₀ #i )
                case ChanIn_S
                solve( In_S( $AS, $PS, aenc(<'ISSUER_REQ', ~km, ~ni>, pk(~sk_ek.1))
                       ) ▶₀ #vr.16 )
                  case ChanIn_S_case_2
                  solve( !KU( aenc(<'ISSUER_REQ', ~km, ~ni>, pk(~sk_ek.1))
                         ) @ #vk.15 )
                    case c_aenc
                    solve( !KU( ~km ) @ #vk.20 )
                      case ISSUER_JOIN_ONE
                      solve( In_S( $AS, $PS,
                                   aenc(<'creI', multp(~creRandom, ~P1), 
                                         multp(~isk, multp(~creRandom, ~P1)), 
                                         plus(multp(~isk, multp(~creRandom, ~P1)),
                                              multp(multp(~creRandom, ~isk),
                                                    multp(~P1, PRF(~DAASeed, ~Ki, ~cnt))))
                                        >,
                                        pk(~sk_ek.1))
                             ) ▶₀ #vr.24 )
                        case ChanIn_S_case_2
                        solve( !KU( aenc(<'creI', multp(~creRandom, ~P1), 
                                          multp(~isk, multp(~creRandom, ~P1)), 
                                          plus(multp(~isk, multp(~creRandom, ~P1)),
                                               multp(multp(~creRandom, ~isk),
                                                     multp(~P1, PRF(~DAASeed, ~Ki, ~cnt))))
                                         >,
                                         pk(~sk_ek.1))
                               ) @ #vk.22 )
                          case c_aenc
                          solve( !KU( ~ni ) @ #vk.23 )
                            case ISSUER_JOIN_ONE
                            solve( !KU( multp(~creRandom, ~P1) ) @ #vk.19 )
                              case ISSUER_JOIN_TWO
                              solve( !KU( plus(~u,
                                               multp(H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                                                        U(~u, ~P1), pk(~isk), ~ni),
                                                     PRF(~DAASeed, ~Ki, ~cnt)))
                                     ) @ #vk.21 )
                                case AS_JOIN_TWO
                                solve( !KU( pk(~sk_ek.1) ) @ #vk.22 )
                                  case PLATFORM_SETUP
                                  SOLVED // trace found
                                qed
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma can_be_deanonymised:
  exists-trace
  "∃ AS PS sigma tsk #i #j #k #l.
    (((PlatformStart( AS, PS ) @ #i) ∧ (RevealPSTsk( PS, tsk ) @ #j)) ∧
     (ASSendFullSignature( AS, PS, sigma ) @ #k)) ∧
    (DeAnonymised( PS, tsk, sigma ) @ #l)"
/*
guarded formula characterizing all satisfying traces:
"∃ AS PS sigma tsk #i #j #k #l.
  (PlatformStart( AS, PS ) @ #i) ∧
  (RevealPSTsk( PS, tsk ) @ #j) ∧
  (ASSendFullSignature( AS, PS, sigma ) @ #k) ∧
  (DeAnonymised( PS, tsk, sigma ) @ #l)"
*/
simplify
solve( !F_PSTsk( $PS, PRF(x, x.1, x.2) ) ▶₀ #j )
  case PS_JOIN_ONE
  solve( !F_BSN( $I, bsn ) ▶₁ #l )
    case ISSUER_SETUP
    solve( !F_IssuerPK( $I, pk(x.3) ) ▶₂ #l )
      case ISSUER_SETUP
      solve( In_S( $PS, $AS,
                   <~sid, 'PSSignResp', multp(PRF(~DAASeed, ~Ki, ~cnt), H1(~bsn)), 
                    H4(H3(multp(x, multp(x.1, x.2)),
                          multp(x, multp(~isk, multp(x.1, x.2))),
                          multp(x,
                                plus(multp(~isk, multp(x.1, x.2)),
                                     multp(multp(x.1, ~isk),
                                           multp(x.2, PRF(~DAASeed, ~Ki, ~cnt))))),
                          multp(x,
                                multp(PRF(~DAASeed, ~Ki, ~cnt), multp(~isk, multp(x.1, x.2)))),
                          nv),
                       m, H1(~bsn), multp(PRF(~DAASeed, ~Ki, ~cnt), H1(~bsn)), ~bsn,
                       multp(~randS1, H1(~bsn)),
                       multp(~randS1, multp(x, multp(~isk, multp(x.1, x.2)))), ~nt), 
                    s(~randS1, PRF(~DAASeed, ~Ki, ~cnt)), ~nt>
             ) ▶₀ #k )
        case ChanIn_S
        solve( St_AS_SIGN_ONE( ~sid, $AS, multp(x, multp(x.1, x.2)),
                               multp(x, multp(~isk, multp(x.1, x.2))),
                               multp(x,
                                     plus(multp(~isk, multp(x.1, x.2)),
                                          multp(multp(x.1, ~isk),
                                                multp(x.2, PRF(~DAASeed, ~Ki, ~cnt))))),
                               multp(x,
                                     multp(PRF(~DAASeed, ~Ki, ~cnt), multp(~isk, multp(x.1, x.2)))),
                               H1(~bsn), nv, m.1
               ) ▶₁ #k )
          case AS_SIGN_ONE
          solve( !RevealedPSTsk( $PS, PRF(~DAASeed, ~Ki, ~cnt) ) ▶₃ #l.1 )
            case REVEAL_TSK
            solve( In_S( $AS.1, $PS, aenc(<'ISSUER_REQ', km, ni>, pk(~sk_ek))
                   ) ▶₀ #vr )
              case ChanIn_S_case_2
              solve( !KU( aenc(<'ISSUER_REQ', km, ni>, pk(~sk_ek)) ) @ #vk.28 )
                case ISSUER_JOIN_ONE
                solve( In_S( $AS, $PS,
                             <~sid, 'PSSign', 
                              H3(multp(~l, multp(x, x.1)), multp(~l, multp(~isk, multp(x, x.1))),
                                 multp(~l,
                                       plus(multp(~isk, multp(x, x.1)),
                                            multp(multp(x, ~isk),
                                                  multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))),
                                 multp(~l,
                                       multp(PRF(~DAASeed, ~Ki, ~cnt), multp(~isk, multp(x, x.1)))),
                                 nv), 
                              H1(~bsn), multp(~l, multp(~isk, multp(x, x.1))), m, ~bsn>
                       ) ▶₀ #vr.4 )
                  case ChanIn_S_case_2
                  solve( In_S( $PS, $AS,
                               <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                                plus(multp(~isk, multp(x, x.1)),
                                     multp(multp(x, ~isk), multp(x.1, PRF(~DAASeed, ~Ki, ~cnt)))), 
                                multp(PRF(~DAASeed, ~Ki, ~cnt), multp(~isk, multp(x, x.1)))>
                         ) ▶₀ #vr.6 )
                    case ChanIn_S
                    solve( In_S( $AS, $PS,
                                 aenc(<'creI', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                                       plus(multp(~isk, multp(x, x.1)),
                                            multp(multp(x, ~isk),
                                                  multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                                      >,
                                      pk(~sk_ek))
                           ) ▶₀ #vr.16 )
                      case ChanIn_S_case_2
                      solve( !KU( aenc(<'creI', multp(x, x.1), 
                                        multp(~isk, multp(x, x.1)), 
                                        plus(multp(~isk, multp(x, x.1)),
                                             multp(multp(x, ~isk),
                                                   multp(x.1, PRF(~DAASeed, ~Ki, ~cnt))))
                                       >,
                                       pk(~sk_ek))
                             ) @ #vk.28 )
                        case ISSUER_JOIN_TWO
                        solve( !KU( multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)) ) @ #vk.32 )
                          case AS_JOIN_TWO
                          solve( !KU( H2(~P1, multp(~P1, PRF(~DAASeed, ~Ki, ~cnt)),
                                         U(x, ~P1), pk(~isk), ~ni)
                                 ) @ #vk.34 )
                            case AS_JOIN_TWO
                            solve( !KU( ~nt ) @ #vk.31 )
                              case AS_SIGN_TWO
                              solve( !KU( s(~randS1, PRF(~DAASeed, ~Ki, ~cnt)) ) @ #vk.30 )
                                case AS_SIGN_TWO
                                solve( !KU( multp(~l, multp(~creRandom, ~P1)) ) @ #vk.18 )
                                  case AS_SIGN_TWO
                                  solve( !KU( multp(~l, multp(~isk, multp(~creRandom, ~P1)))
                                         ) @ #vk.21 )
                                    case AS_SIGN_TWO
                                    solve( !KU( multp(~l,
                                                      plus(multp(~isk, multp(~creRandom, ~P1)),
                                                           multp(multp(~creRandom, ~isk),
                                                                 multp(~P1,
                                                                       PRF(~DAASeed, ~Ki, ~cnt)))))
                                           ) @ #vk.24 )
                                      case AS_SIGN_TWO
                                      solve( !KU( multp(~l,
                                                        multp(PRF(~DAASeed, ~Ki, ~cnt),
                                                              multp(~isk, multp(~creRandom, ~P1))))
                                             ) @ #vk.27 )
                                        case AS_SIGN_TWO
                                        solve( !KU( H1(~bsn) ) @ #vk.29 )
                                          case c_H1
                                          solve( !KU( ~bsn ) @ #vk.38 )
                                            case ISSUER_SETUP
                                            solve( !KU( multp(PRF(~DAASeed, ~Ki, ~cnt), H1(~bsn))
                                                   ) @ #vk.31 )
                                              case AS_SIGN_TWO
                                              solve( In_S( $PS.1, $AS,
                                                           <'cre', multp(x, x.1), 
                                                            multp(~isk, multp(x, x.1)), 
                                                            plus(multp(~isk, multp(x, x.1)),
                                                                 multp(multp(x, ~isk),
                                                                       multp(x.1,
                                                                             PRF(x.2, x.3, x.4)))), 
                                                            multp(PRF(x.2, x.3, x.4),
                                                                  multp(~isk, multp(x, x.1)))
                                                           >
                                                     ) ▶₀ #vr.61 )
                                                case ChanIn_S
                                                solve( In_S( $AS, $PS,
                                                             <~sid.1, 'PSSign', 
                                                              H3(R, S, T, W, nv.1), H1(~bsn), S, 
                                                              m.2, ~bsn>
                                                       ) ▶₀ #vr.62 )
                                                  case ChanIn_S_case_2
                                                  solve( In_S( $AS, $PS,
                                                               aenc(<'creI', multp(x, x.1), 
                                                                     multp(~isk, multp(x, x.1)), 
                                                                     plus(multp(~isk,
                                                                                multp(x, x.1)),
                                                                          multp(multp(x, ~isk),
                                                                                multp(x.1,
                                                                                      PRF(~DAASeed.1,
                                                                                          ~Ki,
                                                                                          ~cnt.1))))
                                                                    >,
                                                                    pk(~sk_ek))
                                                         ) ▶₀ #vr.65 )
                                                    case ChanIn_S_case_2
                                                    solve( !KU( aenc(<'creI', multp(x, x.1), 
                                                                      multp(~isk, multp(x, x.1)), 
                                                                      plus(multp(~isk,
                                                                                 multp(x, x.1)),
                                                                           multp(multp(x, ~isk),
                                                                                 multp(x.1,
                                                                                       PRF(~DAASeed.1,
                                                                                           ~Ki,
                                                                                           ~cnt.1))))
                                                                     >,
                                                                     pk(~sk_ek))
                                                           ) @ #vk.43 )
                                                      case ISSUER_JOIN_TWO
                                                      solve( !KU( H4(H3(multp(~l,
                                                                              multp(~creRandom,
                                                                                    ~P1)),
                                                                        multp(~l,
                                                                              multp(~isk,
                                                                                    multp(~creRandom,
                                                                                          ~P1))),
                                                                        multp(~l,
                                                                              plus(multp(~isk,
                                                                                         multp(~creRandom,
                                                                                               ~P1)),
                                                                                   multp(multp(~creRandom,
                                                                                               ~isk),
                                                                                         multp(~P1,
                                                                                               PRF(~DAASeed,
                                                                                                   ~Ki,
                                                                                                   ~cnt))))),
                                                                        multp(~l,
                                                                              multp(PRF(~DAASeed,
                                                                                        ~Ki, ~cnt),
                                                                                    multp(~isk,
                                                                                          multp(~creRandom,
                                                                                                ~P1)))),
                                                                        nv),
                                                                     m, H1(~bsn),
                                                                     multp(PRF(~DAASeed, ~Ki, ~cnt),
                                                                           H1(~bsn)),
                                                                     ~bsn, multp(~randS1, H1(~bsn)),
                                                                     multp(~randS1,
                                                                           multp(~l,
                                                                                 multp(~isk,
                                                                                       multp(~creRandom,
                                                                                             ~P1)))),
                                                                     ~nt)
                                                             ) @ #vk.32 )
                                                        case AS_SIGN_TWO
                                                        solve( !KU( plus(~u,
                                                                         multp(H2(~P1,
                                                                                  multp(~P1,
                                                                                        PRF(~DAASeed,
                                                                                            ~Ki,
                                                                                            ~cnt)),
                                                                                  U(~u, ~P1),
                                                                                  pk(~isk), ~ni),
                                                                               PRF(~DAASeed, ~Ki,
                                                                                   ~cnt)))
                                                               ) @ #vk.38 )
                                                          case AS_JOIN_TWO
                                                          solve( !KU( MAC(<'gamma', ~P1, 
                                                                           multp(~P1,
                                                                                 PRF(~DAASeed, ~Ki,
                                                                                     ~cnt)), 
                                                                           H2(~P1,
                                                                              multp(~P1,
                                                                                    PRF(~DAASeed,
                                                                                        ~Ki, ~cnt)),
                                                                              U(~u, ~P1), pk(~isk),
                                                                              ~ni), 
                                                                           plus(~u,
                                                                                multp(H2(~P1,
                                                                                         multp(~P1,
                                                                                               PRF(~DAASeed,
                                                                                                   ~Ki,
                                                                                                   ~cnt)),
                                                                                         U(~u, ~P1),
                                                                                         pk(~isk),
                                                                                         ~ni),
                                                                                      PRF(~DAASeed,
                                                                                          ~Ki,
                                                                                          ~cnt)))
                                                                          >,
                                                                          ~km)
                                                                 ) @ #vk.39 )
                                                            case AS_JOIN_TWO
                                                            SOLVED // trace found
                                                          qed
                                                        qed
                                                      qed
                                                    qed
                                                  qed
                                                qed
                                              qed
                                            qed
                                          qed
                                        qed
                                      qed
                                    qed
                                  qed
                                qed
                              qed
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma user_controlled_linkability:
  all-traces
  "∀ k kP j jP #i.
    (((∀ #i.1 #j.1 x.
        ((UniqueExecJoin( x ) @ #i.1) ∧ (UniqueExecJoin( x ) @ #j.1)) ⇒
        (#i.1 = #j.1)) ∧
      (CompareLinkTokens( k, kP, j, jP ) @ #i)) ∧
     (j = jP)) ⇒
    (k = kP)"
/*
guarded formula characterizing all counter-examples:
"∃ k kP j jP #i.
  (CompareLinkTokens( k, kP, j, jP ) @ #i) ∧ (j = jP)
 ∧
  (∀ #i.1 #j.1 x.
    (UniqueExecJoin( x ) @ #i.1) ∧ (UniqueExecJoin( x ) @ #j.1)
   ⇒
    #i.1 = #j.1) ∧
  (¬(k = kP))"
*/
simplify
solve( Sigma( <'sigma', R, S, T, W, j, k, h, s(randS1, tsk), nv, nt
              >
       ) ▶₀ #i )
  case AS_SIGN_TWO
  solve( Sigma( <'sigma', RP, SP, TP, WP, H1(~bsn), kP, hP, ssP, 
                 nvP, ntP>
         ) ▶₁ #i )
    case AS_SIGN_TWO
    solve( In_S( $PS.1, $AS,
                 <'cre', multp(x, x.1), multp(~isk, multp(x, x.1)), 
                  plus(multp(~isk, multp(x, x.1)),
                       multp(multp(x, ~isk), multp(x.1, PRF(x.2, x.3, x.4)))), 
                  multp(PRF(x.2, x.3, x.4), multp(~isk, multp(x, x.1)))>
           ) ▶₀ #vr.5 )
      case ChanIn_S
      solve( In_S( $AS, $PS,
                   <~sid, 'PSSign', H3(R, S, T, W, nv), H1(bsn.1), S, m, bsn.1>
             ) ▶₀ #vr.6 )
        case ChanIn_S_case_1
        by contradiction /* from formulas */
      next
        case ChanIn_S_case_2
        solve( In_S( $AS.1, $PS, aenc(<'ISSUER_REQ', km, ni>, pk(~sk_ek))
               ) ▶₀ #vr.8 )
          case ChanIn_S_case_1
          by contradiction /* from formulas */
        next
          case ChanIn_S_case_2
          solve( !KU( aenc(<'ISSUER_REQ', km, ni>, pk(~sk_ek)) ) @ #vk.9 )
            case ISSUER_JOIN_ONE
            solve( In_S( $AS, $PS,
                         <~sid.1, 'PSSign', H3(R, S, T, W, nv.1), H1(bsn.1), S, m.1, bsn.1>
                   ) ▶₀ #vr.13 )
              case ChanIn_S_case_1
              by contradiction /* from formulas */
            next
              case ChanIn_S_case_2
              by contradiction /* from formulas */
            qed
          next
            case c_aenc
            solve( In_S( $AS, $PS,
                         <~sid.1, 'PSSign', H3(R, S, T, W, nv.1), H1(bsn.1), S, m.1, bsn.1>
                   ) ▶₀ #vr.13 )
              case ChanIn_S_case_1
              by contradiction /* from formulas */
            next
              case ChanIn_S_case_2
              by contradiction /* from formulas */
            qed
          qed
        qed
      qed
    qed
  qed
qed

/* All well-formedness checks were successful. */

end